<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sabemos</title>
<script src="/assets/tailwind.js"></script>
<link href="/assets/fonts.css" rel="stylesheet">
<style>
  body {
    font-family: 'Orbitron', sans-serif;
    background-color: #0f172a;
    color: white;
  }
  #contenedor-tarjetas img { background-color: white; }
  .line-clamp-5 {
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
</head>
<body class="min-h-screen p-6">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="/../e.html" class="mx-3 hover:text-yellow-400">Inicio</a>
  </nav>

  <!-- Encabezado -->
  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <div class="absolute -left-4 md:-left-10 z-20">
        <video autoplay muted loop class="w-40 h-40 md:w-52 md:h-52 object-cover rounded-full border-4 border-yellow-400 shadow-2xl">
          <source src="ruta/sabemos.mp4" type="video/mp4">
        </video>
      </div>
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center pl-48 pr-6 z-10 shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold ml-auto">Adoctrinar != Enseñar</h2>
      </div>
    </div>
    <div style="height: 80px;">&nbsp;</div>
<a href="sabemos imagen.html"></a> | <a href="sabemos.html"></a> 
    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
      <div class="flex gap-2 flex-col md:flex-row w-full md:w-auto">
        <input type="text" id="filtro-nombre" placeholder="Filtrar por nombre..." class="w-full md:w-52 px-2 py-1 rounded text-black" />
        <select id="filtro-departamento" class="w-full md:w-52 px-2 py-1 rounded text-black">
          <option value="">Todos los Departamentos</option>
        </select>
      </div>
    </div>

    <!-- Tarjetas -->
    <div id="contenedor-tarjetas" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <!-- Paginación -->
    <div class="flex justify-center mt-6 flex-wrap gap-2" id="paginacion"></div>

    <div class="flex justify-end mb-4">
      <button onclick="abrirModalInsertar()" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded">
        + Nuevo Artículo
      </button>
    </div>
  </section>

  <!-- Modal Ver Más -->
  <div id="modalVerMas" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg max-w-xl w-full text-black">
      <h2 class="text-xl font-bold mb-2" id="verMasTitulo"></h2>
      <p class="text-sm mb-4" id="verMasDescripcion"></p>
      <button onclick="cerrarModal('modalVerMas')" class="px-4 py-2 bg-gray-600 text-white rounded">Cerrar</button>
    </div>
  </div>

  <!-- Modal Editar -->
  <div id="modalEditar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <form id="formEditar" class="bg-white p-6 rounded-lg max-w-xl w-full text-black">
      <h2 class="text-xl font-bold mb-4">Editar Artículo</h2>
      <input type="hidden" id="editId" />
      <label class="block mb-2">Nombre:</label>
      <input type="text" id="editNombre" class="w-full mb-4 p-2 border rounded" required />
      <label class="block mb-2">Descripción:</label>
      <textarea id="editDescripcion" class="w-full mb-4 p-2 border rounded" rows="4" required></textarea>
      <label class="block mb-2">Departamento:</label>
      <select id="editDepartamento" class="w-full mb-4 p-2 border rounded"></select>
      <label class="block mb-2">Imagen:</label>
      <input type="file" id="editImagen" accept="image/*" class="mb-4" />
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModal('modalEditar')" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Guardar</button>
      </div>
    </form>
  </div>

  <!-- Modal Insertar -->
  <div id="modalInsertar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <form id="formInsertar" class="bg-white p-6 rounded-lg max-w-xl w-full text-black">
      <h2 class="text-xl font-bold mb-4">Nuevo Artículo</h2>
      <label class="block mb-2">Nombre:</label>
      <input type="text" id="insertNombre" class="w-full mb-4 p-2 border rounded" required />
      <label class="block mb-2">Descripción:</label>
      <textarea id="insertDescripcion" class="w-full mb-4 p-2 border rounded" rows="4" required></textarea>
      <label class="block mb-2">Departamento:</label>
      <select id="insertDepartamento" class="w-full mb-4 p-2 border rounded"></select>
      <label class="block mb-2">Imagen:</label>
      <input type="file" id="insertImagen" accept="image/*" class="mb-4" />
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModal('modalInsertar')" class="px-4 py-2 bg-gray-600 text-white rounded">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Guardar</button>
      </div>
    </form>
  </div>

<script>
  const contenedor = document.getElementById("contenedor-tarjetas");
  const filtroNombre = document.getElementById("filtro-nombre");
  const filtroDepartamento = document.getElementById("filtro-departamento");
  const paginacion = document.getElementById("paginacion");
  const editDepartamento = document.getElementById("editDepartamento");
  const insertDepartamento = document.getElementById("insertDepartamento");

  let sabemos = [];
  let paginaActual = 1;
  const articulosPorPagina = 8;

  const departamentos = {
    0: "Prehistoria",
    1: "-100 Ac",
    2: "Edad Media",
    3: "Ilustración"
  };

  // Cargar opciones en selects
  for (const [valor, nombre] of Object.entries(departamentos)) {
    filtroDepartamento.appendChild(new Option(nombre, valor));
    editDepartamento.appendChild(new Option(nombre, valor));
    insertDepartamento.appendChild(new Option(nombre, valor));
  }

  function verMas(id) {
    const numId = Number(id);
    const item = (sabemos || []).find(a => Number(a.id ?? a.id_articulo) === numId);
    if (!item) return;
    document.getElementById("verMasTitulo").textContent = item.nombre ?? "Sin nombre";
    document.getElementById("verMasDescripcion").textContent = item.descripcion ?? "";
    document.getElementById("modalVerMas").classList.remove("hidden");
    document.getElementById("modalVerMas").classList.add("flex");
  }

  function abrirModalEditar(id) {
    const numId = Number(id);
    const item = (sabemos || []).find(a => Number(a.id ?? a.id_articulo) === numId);
    if (!item) return;
    document.getElementById("editId").value = item.id ?? item.id_articulo ?? "";
    document.getElementById("editNombre").value = item.nombre ?? "";
    document.getElementById("editDescripcion").value = item.descripcion ?? "";
    document.getElementById("editDepartamento").value = String(item.departamento ?? "");
    document.getElementById("modalEditar").classList.remove("hidden");
    document.getElementById("modalEditar").classList.add("flex");
  }

  function abrirModalInsertar() {
    document.getElementById("insertNombre").value = "";
    document.getElementById("insertDescripcion").value = "";
    document.getElementById("insertDepartamento").value = "";
    document.getElementById("insertImagen").value = "";
    document.getElementById("modalInsertar").classList.remove("hidden");
    document.getElementById("modalInsertar").classList.add("flex");
  }

  function cerrarModal(id) {
    const modal = document.getElementById(id);
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  function mostrarArticulos() {
    if (!Array.isArray(sabemos)) sabemos = []; // Airbag

    const filtroNombreValor = (filtroNombre.value || "").toLowerCase();
    const filtroDeptoValor = String(filtroDepartamento.value ?? "");

    const filtrados = sabemos.filter(a => {
      const nombre = String(a.nombre ?? "");
      const depto = String(a.departamento ?? "");
      const coincideNombre = nombre.toLowerCase().includes(filtroNombreValor);
      const coincideDepto = (filtroDeptoValor === "" || depto === filtroDeptoValor);
      return coincideNombre && coincideDepto;
    });

    const totalPaginas = Math.max(1, Math.ceil(filtrados.length / articulosPorPagina));
    if (paginaActual > totalPaginas) paginaActual = 1;

    const inicio = (paginaActual - 1) * articulosPorPagina;
    const paginados = filtrados.slice(inicio, inicio + articulosPorPagina);

    contenedor.innerHTML = "";
    paginados.forEach(a => {
      const nombre = a.nombre ?? "Sin nombre";
      const descripcion = a.descripcion ?? "";
      const descripcionCorta = descripcion.length > 300 ? descripcion.slice(0, 300) + "..." : descripcion;
      const imagen = a.imagen || "/sabemos/ima/default.png";
      const departamentoNombre = departamentos[a.departamento] || "Desconocido";
      const id = Number(a.id ?? a.id_articulo ?? 0);

      const card = document.createElement("div");
      card.className = "bg-gray-800 rounded-lg shadow-md p-4 flex flex-col items-center";
      card.innerHTML = `
        <img src="${imagen}" alt="${nombre}" class="w-full h-40 object-cover rounded mb-2 shadow">
        <h3 class="text-yellow-400 font-bold text-lg text-center">${nombre}</h3>
        <p class="text-sm text-gray-300 text-center mb-2">${departamentoNombre}</p>
        <p class="text-white text-center text-xs line-clamp-5">${descripcionCorta}</p>
        <div class="mt-2 flex gap-2 justify-center">
          <button onclick="verMas(${id})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded">Ver más</button>
          <button onclick="abrirModalEditar(${id})" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded">Editar</button>
          <button onclick="eliminarSabemos(${id})" class="bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded">Eliminar</button>
        </div>
      `;
      contenedor.appendChild(card);
    });

    paginacion.innerHTML = "";
    for (let i = 1; i <= totalPaginas; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = `px-2 py-1 rounded ${i === paginaActual ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white'} hover:bg-yellow-500 transition`;
      btn.onclick = () => {
        paginaActual = i;
        mostrarArticulos();
      };
      paginacion.appendChild(btn);
    }
  }

  filtroNombre.addEventListener("input", () => {
    paginaActual = 1;
    mostrarArticulos();
  });

  filtroDepartamento.addEventListener("change", () => {
    paginaActual = 1;
    mostrarArticulos();
  });

  // ⚠️ Si sirves bajo subpath, usa "api/sabemos" relativo. Mantengo absoluto.
  fetch("/api/sabemos")
    .then(async res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        sabemos = data;
      } else if (Array.isArray(data?.data)) {
        sabemos = data.data;
      } else if (Array.isArray(data?.items)) {
        sabemos = data.items;
      } else {
        console.error("Respuesta no es un array:", data);
        sabemos = [];
      }
      mostrarArticulos();
    })
    .catch(err => {
      contenedor.innerHTML = `<p class="text-red-500">Error al cargar los artículos.</p>`;
      console.error("Error cargando /api/sabemos:", err);
      sabemos = [];
    });

  document.getElementById("formInsertar").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append("nombre", document.getElementById("insertNombre").value);
    formData.append("descripcion", document.getElementById("insertDescripcion").value);
    formData.append("departamento", document.getElementById("insertDepartamento").value);
    const file = document.getElementById("insertImagen").files[0];
    if (file) formData.append("imagen", file);

    fetch("/api/sabemos", { method: "POST", body: formData })
      .then(async res => {
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.success) throw json;
        cerrarModal("modalInsertar");
        location.reload();
      })
      .catch(err => {
        alert("Error al crear artículo");
        console.error(err);
      });
  });

  document.getElementById("formEditar").addEventListener("submit", function (e) {
    e.preventDefault();
    const id = document.getElementById("editId").value;
    const formData = new FormData();
    formData.append("nombre", document.getElementById("editNombre").value);
    formData.append("descripcion", document.getElementById("editDescripcion").value);
    formData.append("departamento", document.getElementById("editDepartamento").value);
    const file = document.getElementById("editImagen").files[0];
    if (file) formData.append("imagen", file);

    fetch(`/api/sabemos/${id}`, { method: "PUT", body: formData })
      .then(async res => {
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.success) throw json;
        cerrarModal("modalEditar");
        location.reload();
      })
      .catch(err => {
        alert("Error al editar artículo");
        console.error(err);
      });
  });

  function eliminarSabemos(id) {
    if (!confirm("¿Seguro que deseas eliminar este artículo?")) return;
    fetch(`/api/sabemos/${id}`, { method: "DELETE" })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          const numId = Number(id);
          sabemos = (sabemos || []).filter(a => Number(a.id ?? a.id_articulo) !== numId);
          mostrarArticulos();
        } else {
          alert(res.error || "Error al eliminar");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error de conexión");
      });
  }
</script>
</body>
</html>
