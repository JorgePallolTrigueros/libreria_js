<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pagos pendientes — editor</title>
 
   <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
 
 
 <style>

    tfoot tr { background:#0b132a; border:1px solid #1f2937; }
tfoot td { padding:10px; font-weight:700; }
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1025,#0f172a 30%,#0b1025);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(6px);border-bottom:1px solid #1f2937;z-index:10}
    header .wrap{max-width:1100px;margin:auto;display:flex;gap:16px;align-items:center;padding:12px 16px}
    .badge{padding:6px 10px;border-radius:999px;background:#0b3b46;border:1px solid #164e63;color:#99f6e4;font-weight:600;font-size:12px}
    main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:20px}
    .panel{background:linear-gradient(180deg,#0b1228,#0b132a);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h2{margin:0;padding:14px 16px;border-bottom:1px solid #1f2937;font-size:16px;color:#cbd5e1;display:flex;align-items:center;gap:10px}
    .panel .content{padding:16px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .row>*{flex:1 1 140px}
    input,select,button{appearance:none}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1228;color:var(--text)}
    input[type=number]{text-align:right}
    input:focus{outline:none;border-color:#155e75;box-shadow:0 0 0 3px rgba(45,212,191,.15)}
    button{padding:10px 14px;border-radius:10px;border:1px solid #164e63;background:#083344;color:#a5f3fc;font-weight:600;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .btn-ghost{background:transparent;border-color:#334155;color:#cbd5e1}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;letter-spacing:.02em;text-transform:uppercase;color:#94a3b8;font-weight:700;text-align:left;padding:0 8px}
    tbody tr{background:#0a0f23;border:1px solid #1f2937}
    tbody td{padding:8px}
    tbody tr{border-radius:12px;overflow:hidden}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .num{font-variant-numeric:tabular-nums;text-align:right}
    .muted{color:var(--muted)}
    .totales{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .kpi{padding:12px;border-radius:14px;border:1px solid #1f2937;background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.08),#0b1228)}
    .kpi .label{font-size:12px;color:#93c5fd}
    .kpi .value{font-size:24px;font-weight:800;margin-top:6px}
    .footer{color:#94a3b8;font-size:12px;text-align:center;padding:10px 0}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>


 <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }
    #contenedor-tarjetas img {
      background-color: white;
    }
    .line-clamp-5 {
      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="/../f.html" class="mx-3 hover:text-yellow-400">Inicio</a>
  </nav>

  <!-- Encabezado -->
  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <div class="absolute -left-4 md:-left-10 z-20">
        <video autoplay muted loop
               class="w-40 h-40 md:w-52 md:h-52 object-cover rounded-full border-4 border-yellow-400 shadow-2xl">
          <source src="/ruta/compras.mp4" type="video/mp4">
        </video>
      </div>
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center pl-48 pr-6 z-10 shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold ml-auto">Gastos</h2>
      </div>
    </div>
  <div style="height: 100px;">&nbsp;</div>
    <div>
      <a href="login.html" class="bg-yellow-400 text-black px-4 py-2 rounded font-bold hover:bg-yellow-300 transition">
        Iniciar sesión
      </a>
    </div>



  <header>
    <div class="wrap">
      <span class="badge">Pagos pendientes</span>
      <div class="muted">Editor CRUD + cálculo de cuotas</div>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>Resumen</h2>
      <div class="content">
        <div class="totales">
          <div class="kpi"><div class="label">Total mensual (día 1)</div><div class="value" id="kpiMensual">0,00 €</div></div>
          <div class="kpi"><div class="label">Pagos activos</div><div class="value" id="kpiActivos">0</div></div>
          <div class="kpi"><div class="label">Cuotas pendientes (suma)</div><div class="value" id="kpiCuotas">0</div></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Listado / edición</h2>
      <div class="content">
        <div class="row" style="margin-bottom:12px">
          <input id="filtro" placeholder="Filtrar por concepto o tarjeta…" />
          <div class="stack">
            <button id="btnAgregar">➕ Añadir fila</button>
            <button id="btnCerrarCuotaMes" class="btn-ghost" title="Resta 1 a todas las cuotas (simula pagar este mes)">✅ Pagar una cuota a todos</button>
            <button id="btnLimpiarFiltros" class="btn-ghost">Limpiar filtro</button>
          </div>
        </div>
        <div class="tabla-wrap">
          <table>
              <thead>
                <tr>
                  <th>Tarjeta</th>
                  <th>Concepto</th>
                  <th class="num">Importe</th>
                  <th>Tipo cuota</th>
                  <th class="num">€/cuota</th>
                  <th class="num">Pendientes</th>
                  <th class="num">Mensual</th>
                  <th class="num">Restante</th> <!-- NUEVA -->
                  <th>Acciones</th>
                </tr>
              </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Proyección mensual (12 meses)</h2>
      <div class="content">
        <div id="forecast"></div>
      </div>
    </section>

    <div class="footer">Pon este archivo junto a <b>pagos pendientes.js</b>. Los cambios viven en memoria mientras la página está abierta.</div>
  </main>

  <!-- Carga SIEMPRE desde el archivo fijo con el array -->
  <script src="pagos pendientes.js"></script>
<script>
  // Lee pagosPendientes o movimientos del script previo
  const inicial = (typeof pagosPendientes !== 'undefined' ? pagosPendientes
                  : (typeof movimientos !== 'undefined' ? movimientos : []));

  let data = cargarDatos();

  function cargarDatos(){
    const src = Array.isArray(inicial) ? inicial : [];
    return src.map(n => ({
      tarjeta: n.tarjeta || "",
      concepto: n.concepto || "",
      importe: Number(n.importe)||0,
      tipoCuota: n.tipoCuota ?? String(n.tipoCuota ?? ""),
      precioCuota: Number(n.precioCuota)||0,
      cuotasPendientes: Math.max(0, parseInt(n.cuotasPendientes)||0),
    }));
  }

  let sortField = null;
  let sortAsc = true;

  function guardarDatos(){ render(); }

  const tbody = document.getElementById('tbody');
  const filtro = document.getElementById('filtro');
  filtro.addEventListener('input', render);
  document.getElementById('btnLimpiarFiltros').onclick = () => { filtro.value = ""; render(); };

  function inputCell(value, onChange, type = 'text', step){
    const el = document.createElement('input');
    el.value = value ?? '';
    el.type = type;
    if(type==='number'){ el.step = step ?? '0.01'; }
    el.onchange = e => onChange(type==='number' ? Number(e.target.value) : e.target.value);
    return el;
  }
  function btn(label, cls, click){ const b = document.createElement('button'); b.textContent = label; b.className = cls; b.onclick = click; return b; }

  function render(){
    const term = (filtro.value||'').toLowerCase();
    tbody.innerHTML = '';

    // Acumuladores de totales del filtro
    let totalMensualFiltro = 0;
    let totalRestanteFiltro = 0;

    const rows = data.map((r,idx)=>({ ...r, _idx: idx }))
                     .filter(r => !term || (r.concepto+" "+r.tarjeta).toLowerCase().includes(term));

    // ORDENAMIENTO antes de pintar
    if (sortField) {
      rows.sort((a,b)=>{
        const mensualA = (a.cuotasPendientes>0 ? Number(a.precioCuota)||0 : 0);
        const mensualB = (b.cuotasPendientes>0 ? Number(b.precioCuota)||0 : 0);
        const restanteA = (Number(a.precioCuota)||0) * (parseInt(a.cuotasPendientes)||0);
        const restanteB = (Number(b.precioCuota)||0) * (parseInt(b.cuotasPendientes)||0);

        const va =
          sortField === 'restante' ? restanteA :
          sortField === 'mensual'  ? mensualA  :
          a[sortField];

        const vb =
          sortField === 'restante' ? restanteB :
          sortField === 'mensual'  ? mensualB  :
          b[sortField];

        if (typeof va === 'string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        return sortAsc ? (va - vb) : (vb - va);
      });
    }

    for(const r of rows){
      const tr = document.createElement('tr');

      let td = document.createElement('td');
      td.appendChild(inputCell(r.tarjeta, v=>{ data[r._idx].tarjeta=v; guardarDatos(); })); tr.appendChild(td);

      td = document.createElement('td');
      td.appendChild(inputCell(r.concepto, v=>{ data[r._idx].concepto=v; guardarDatos(); })); tr.appendChild(td);

      td = document.createElement('td'); td.className='num';
      td.appendChild(inputCell(r.importe, v=>{ data[r._idx].importe=v||0; guardarDatos(); }, 'number')); tr.appendChild(td);

      td = document.createElement('td');
      td.appendChild(inputCell(r.tipoCuota, v=>{ data[r._idx].tipoCuota=v; guardarDatos(); })); tr.appendChild(td);

      td = document.createElement('td'); td.className='num';
      td.appendChild(inputCell(r.precioCuota, v=>{ data[r._idx].precioCuota=v||0; guardarDatos(); }, 'number')); tr.appendChild(td);

      td = document.createElement('td'); td.className='num';
      const box = document.createElement('div'); box.style.display='flex'; box.style.gap='6px'; box.style.justifyContent='flex-end';
      const menos = btn('−', 'btn-ghost', ()=>{ if(data[r._idx].cuotasPendientes>0){ data[r._idx].cuotasPendientes--; guardarDatos(); }});
      const mas = btn('+', 'btn-ghost', ()=>{ data[r._idx].cuotasPendientes++; guardarDatos(); });
      const inp = inputCell(r.cuotasPendientes, v=>{ data[r._idx].cuotasPendientes=Math.max(0, parseInt(v)||0); guardarDatos(); }, 'number', 1);
      inp.step='1'; inp.min='0'; inp.style.maxWidth='88px';
      box.append(menos, inp, mas); td.appendChild(box); tr.appendChild(td);

      // Mensual (solo si quedan cuotas)
      const mensualFila = (r.cuotasPendientes>0 ? Number(r.precioCuota)||0 : 0);
      td = document.createElement('td'); td.className='num';
      td.textContent = euro(mensualFila); tr.appendChild(td);

      // Restante = €/cuota * pendientes
      const restanteFila = (Number(r.precioCuota)||0) * (parseInt(r.cuotasPendientes)||0);
      td = document.createElement('td'); td.className='num';
      td.textContent = euro(restanteFila); tr.appendChild(td);

      // Acumular totales del filtro
      totalMensualFiltro += mensualFila;
      totalRestanteFiltro += restanteFila;

      td = document.createElement('td');
      const acciones = document.createElement('div'); acciones.className='stack';
      acciones.append(
        btn('🗑️ Borrar','btn-ghost',()=>{ if(confirm('¿Eliminar este registro?')){ data.splice(r._idx,1); guardarDatos(); }}),
        btn('✔️ Cerrar 1 cuota','btn-ghost',()=>{ if(data[r._idx].cuotasPendientes>0){ data[r._idx].cuotasPendientes--; guardarDatos(); } })
      );
      td.appendChild(acciones); tr.appendChild(td);

      tbody.appendChild(tr);
    }

    // Pintar KPIs (globales)
    pintarKPIs();
    pintarForecast();

    // Pie de tabla con totales del filtro
    const table = document.querySelector('.tabla-wrap table');
    let tfoot = table.querySelector('tfoot');
    if(tfoot) tfoot.remove();
    tfoot = document.createElement('tfoot');

    const trFoot = document.createElement('tr');
    const tdLabel = document.createElement('td');
    tdLabel.colSpan = 6; // Tarjeta, Concepto, Importe, Tipo cuota, €/cuota, Pendientes
    tdLabel.textContent = 'Totales (filtrado):';
    tdLabel.className = 'muted';
    trFoot.appendChild(tdLabel);

    const tdMensual = document.createElement('td'); // Mensual
    tdMensual.className = 'num';
    tdMensual.textContent = euro(totalMensualFiltro);
    trFoot.appendChild(tdMensual);

    const tdRestante = document.createElement('td'); // Restante
    tdRestante.className = 'num';
    tdRestante.textContent = euro(totalRestanteFiltro);
    trFoot.appendChild(tdRestante);

    const tdVacio = document.createElement('td'); // Acciones
    trFoot.appendChild(tdVacio);

    tfoot.appendChild(trFoot);
    table.appendChild(tfoot);

    // Indicadores ↑ ↓ en cabecera
    pintarIndicadoresOrden();
  }

  function totalMensual(){ return data.reduce((acc,r)=> acc + (r.cuotasPendientes>0 ? Number(r.precioCuota)||0 : 0), 0); }
  function pintarKPIs(){
    document.getElementById('kpiMensual').textContent = euro(totalMensual());
    document.getElementById('kpiActivos').textContent = data.filter(r=>r.cuotasPendientes>0).length;
    document.getElementById('kpiCuotas').textContent = data.reduce((a,b)=>a + (parseInt(b.cuotasPendientes)||0),0);
  }

  function forecast12(){
    const meses = [];
    for(let m=0; m<12; m++){
      const total = data.reduce((acc,r)=> acc + ((r.cuotasPendientes - m) > 0 ? (Number(r.precioCuota)||0) : 0), 0);
      meses.push(total);
    }
    return meses;
  }
  function pintarForecast(){
    const wrap = document.getElementById('forecast');
    const meses = ["Mes 1","Mes 2","Mes 3","Mes 4","Mes 5","Mes 6","Mes 7","Mes 8","Mes 9","Mes 10","Mes 11","Mes 12"];
    const vals = forecast12();
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    meses.forEach(m=>{ const th=document.createElement('th'); th.textContent=m; trh.appendChild(th); });
    thead.appendChild(trh);
    const tbodyF = document.createElement('tbody');
    const tr = document.createElement('tr');
    vals.forEach(v=>{ const td=document.createElement('td'); td.className='num'; td.textContent=euro(v); tr.appendChild(td); });
    tbodyF.appendChild(tr);
    table.append(thead, tbodyF);
    wrap.innerHTML=''; wrap.appendChild(table);
  }

  document.getElementById('btnAgregar').onclick = ()=>{
    data.push({ tarjeta:"", concepto:"", importe:0, tipoCuota:"12 meses", precioCuota:0, cuotasPendientes:12 });
    guardarDatos();
  };
  document.getElementById('btnCerrarCuotaMes').onclick = ()=>{
    if(!data.length) return;
    if(!confirm('Esto resta 1 cuota a TODOS los registros con cuotas > 0. ¿Continuar?')) return;
    data = data.map(r => ({...r, cuotasPendientes: Math.max(0, (parseInt(r.cuotasPendientes)||0) - 1)}));
    guardarDatos();
  };

  function euro(n){ return (Number(n)||0).toLocaleString('es-ES', {style:'currency', currency:'EUR'}); }

  // Click en cabeceras para ordenar
  document.querySelectorAll('thead th').forEach((th, i) => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const map = [
        "tarjeta", "concepto", "importe", "tipoCuota",
        "precioCuota", "cuotasPendientes", "mensual", "restante", /* acciones -> undefined */
      ];
      const field = map[i];
      if(!field) return; // columnas como acciones o sin datos no se ordenan

      if(sortField === field) sortAsc = !sortAsc; // alternar
      else { sortField = field; sortAsc = true; } // nueva columna => asc

      render();
    });
  });

  function pintarIndicadoresOrden(){
    const ths = document.querySelectorAll('thead th');
    ths.forEach(th => { th.textContent = th.textContent.replace(/[↑↓]/g,''); });

    const indexMap = { tarjeta:0, concepto:1, importe:2, tipoCuota:3, precioCuota:4, cuotasPendientes:5, mensual:6, restante:7 };
    const idx = indexMap[sortField];
    if(idx !== undefined){
      const th = ths[idx];
      if(th) th.textContent += sortAsc ? ' ↑' : ' ↓';
    }
  }

  // Inicio
  render();
</script>
</body>
</html>
