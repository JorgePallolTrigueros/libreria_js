<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ocurrencias</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }
  </style>
</head>
<body class="min-h-screen">
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider flex justify-between">
    <a href="/reportajes/strump/index.html" class="mx-3 hover:text-yellow-400">Inicio</a>
    <div id="loginStatus" class="text-right text-sm">
      <button onclick="cerrarSesion()" class="bg-red-500 hover:bg-red-700 px-4 py-1 rounded">Cerrar sesión</button>
    </div>
  </nav>

  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center justify-center shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold">Ocurrencias de Trump (2º Mandato)</h2>
      </div>
    </div>
  </section>

  <section class="max-w-5xl mx-auto px-4 mb-4 text-right">
    <button onclick="abrirModalNueva()" id="btnNueva" class="bg-yellow-400 text-black px-4 py-2 rounded hover:bg-yellow-300 font-bold hidden">➕ Nueva Ocurrencia</button>
  </section>

  <section class="max-w-5xl mx-auto px-4">
    <table class="w-full table-auto border-collapse text-sm md:text-base">
      <thead>
        <tr class="bg-purple-700 text-yellow-300">
          <th class="p-2 text-left">Ocurrencia</th>
          <th class="p-2">Fecha</th>
          <th class="p-2">Logrado</th>
          <th class="p-2">Resultado</th>
          <th class="p-2">Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-tonterias"></tbody>
    </table>
  </section>

  <!-- Modal Mostrar -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 p-6 rounded-xl max-w-md text-white">
      <h3 class="text-xl font-bold mb-4">Descripción</h3>
      <p id="modal-texto"></p>
      <button onclick="cerrarModal()" class="mt-4 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-300">Cerrar</button>
    </div>
  </div>

  <!-- Modal Editar -->
  <div id="modal-editar" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 p-6 rounded-xl max-w-lg w-full text-white">
      <h3 class="text-xl font-bold mb-4" id="titulo-modal">Editar Ocurrencia</h3>
      <form id="form-editar" class="space-y-4">
        <input type="hidden" id="editar-id" />
        <div>
          <label class="block">Nombre</label>
          <input type="text" id="editar-nombre" class="w-full p-2 rounded bg-gray-700 text-white" required />
        </div>
        <div>
          <label class="block">Fecha</label>
          <input type="date" id="editar-fecha" class="w-full p-2 rounded bg-gray-700 text-white" required />
        </div>
        <div>
          <label class="block">Resultado</label>
          <input type="text" id="editar-resultado" class="w-full p-2 rounded bg-gray-700 text-white" required />
        </div>
        <div>
          <label class="block">Texto</label>
          <textarea id="editar-texto" class="w-full p-2 rounded bg-gray-700 text-white" required></textarea>
        </div>
        <div>
          <label class="inline-flex items-center space-x-2">
            <input type="checkbox" id="editar-logrado" class="form-checkbox" />
            <span>Logrado</span>
          </label>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="cerrarModalEditar()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 rounded">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-300">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const estaLogeado = localStorage.getItem("admin") !== null;
    let tonterias = [];

    async function cargarTonterias() {
      try {
        const res = await fetch("/api/locuras");
        tonterias = await res.json();
        renderTabla();
        if (estaLogeado) document.getElementById("btnNueva").classList.remove("hidden");
      } catch (err) {
        console.error("❌ Error cargando locuras:", err);
      }
    }

    function renderTabla() {
      const tbody = document.getElementById("tabla-tonterias");
      tbody.innerHTML = "";
      tonterias.forEach(t => {
        const fila = document.createElement("tr");
        fila.className = "border-b border-gray-600 hover:bg-gray-800";
        fila.innerHTML = `
          <td class="p-2">${t.Nombre}</td>
          <td class="p-2 text-center">${t.fecha}</td>
          <td class="p-2 text-center">${t.Logrado ? "Sí" : "No"}</td>
          <td class="p-2 text-center">${t.Resultado}</td>
          <td class="p-2 text-center">
            ${estaLogeado ? `
              <button onclick="mostrarModal('${t.text.replace(/'/g, "\'")}')" class="text-yellow-300 hover:text-yellow-400 px-2">Mostrar</button>
              <button onclick="editarTonteria(${t.id_tonteria})" class="text-green-400 hover:text-green-500 px-2">Editar</button>
              <button onclick="borrarTonteria(${t.id_tonteria})" class="text-red-400 hover:text-red-500 px-2">Borrar</button>
            ` : '<span class="text-gray-500">Solo logeado</span>'}
          </td>`;
        tbody.appendChild(fila);
      });
    }

    function mostrarModal(texto) {
      document.getElementById("modal-texto").innerText = texto;
      document.getElementById("modal").classList.remove("hidden");
    }

    function cerrarModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    function cerrarModalEditar() {
      document.getElementById("modal-editar").classList.add("hidden");
    }

    function editarTonteria(id) {
      const t = tonterias.find(item => item.id_tonteria === id);
      if (!t) return alert("No se encontró la tontería");
      document.getElementById("titulo-modal").innerText = "Editar Ocurrencia";
      document.getElementById("editar-id").value = t.id_tonteria;
      document.getElementById("editar-nombre").value = t.Nombre;
      document.getElementById("editar-fecha").value = t.fecha;
      document.getElementById("editar-resultado").value = t.Resultado;
      document.getElementById("editar-texto").value = t.text;
      document.getElementById("editar-logrado").checked = !!t.Logrado;
      document.getElementById("modal-editar").classList.remove("hidden");
    }

    function abrirModalNueva() {
      document.getElementById("titulo-modal").innerText = "Nueva Ocurrencia";
      document.getElementById("editar-id").value = "";
      document.getElementById("form-editar").reset();
      document.getElementById("modal-editar").classList.remove("hidden");
    }

    async function borrarTonteria(id) {
      if (confirm("¿Deseas borrar esta ocurrencia?")) {
        await fetch("/api/locuras/" + id, { method: "DELETE" });
        cargarTonterias();
      }
    }

    document.getElementById("form-editar").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editar-id").value;
      const datos = {
        Nombre: document.getElementById("editar-nombre").value,
        fecha: document.getElementById("editar-fecha").value,
        Resultado: document.getElementById("editar-resultado").value,
        text: document.getElementById("editar-texto").value,
        Logrado: document.getElementById("editar-logrado").checked ? 1 : 0
      };

      const url = id ? `/api/locuras/${id}` : `/api/locuras`;
      const method = id ? "PUT" : "POST";

      await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      cerrarModalEditar();
      cargarTonterias();
    });

    function cerrarSesion() {
      localStorage.removeItem("admin");
      location.reload();
    }

    cargarTonterias();
  </script>
</body>
</html>
