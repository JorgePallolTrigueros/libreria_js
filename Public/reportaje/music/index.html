<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Music</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }
    #search-input, #filter-select {
      background-color: rgb(31 41 55 / var(--tw-bg-opacity, 1));
      width: auto;
      height: 48px;
    }
    .modal-bg {
      background-color: rgba(0, 0, 0, 0.75);
    }
  </style>
</head>
<body>

<!-- Navbar -->
  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="/../e.html" class="mx-3 hover:text-yellow-400">Inicio</a>
  </nav>

  <!-- Encabezado -->
  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <div class="absolute -left-4 md:-left-10 z-20">
  <video autoplay muted loop
         class="w-40 h-40 md:w-52 md:h-52 object-cover rounded-full border-4 border-yellow-400 shadow-2xl">
    <source src="music.mp4" type="video/mp4">
  </video>
      </div>
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center pl-48 pr-6 z-10 shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold ml-auto">Obras</h2>
      </div>
    </div>


  <!-- Filtros -->
  <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6 mb-6">
    <div class="text-center">
      <label for="continentFilter" class="block text-yellow-400 font-semibold">Filtrar por continente</label>
      <select id="continentFilter" class="bg-gray-800 text-white px-4 py-2 rounded w-64">
        <option value="all">Mostrar todo</option>
        <option value="asia">Asia</option>
        <option value="america">Am√©rica</option>
        <option value="europa">Europa</option>
      </select>
    </div>
    <div class="text-center">
      <label for="searchInput" class="block text-yellow-400 font-semibold">Buscar por t√≠tulo</label>
      <input type="text" id="searchInput" placeholder="Ej: Stromae" class="bg-gray-800 text-white px-4 py-2 rounded w-64"/>
    </div>
  </div>



  <!-- Bot√≥n de administrador -->
    <button onclick="mostrarFormularioInsertar()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">‚ûï Nueva Canci√≥n</button>
 





  <!-- Tarjetas -->
  <div id="cardsContainer" class="grid md:grid-cols-3 gap-6"></div>
  <div id="pagination" class="flex justify-center items-center mt-8 gap-4"></div>
</section>

<!-- Modal formulario -->
<div id="formularioModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-bg">
  <div class="bg-gray-900 p-6 rounded-xl max-w-xl w-full shadow-lg relative">
    <button onclick="cancelarFormulario()" class="absolute top-2 right-2 text-yellow-400 text-xl hover:text-white">&times;</button>
    <h2 class="text-yellow-400 text-xl font-bold mb-4">üéµ Nueva/Editar Canci√≥n</h2>
    <input type="hidden" id="editIndex">
    <input type="text" id="tituloInput" placeholder="T√≠tulo" class="w-full p-2 mb-3 rounded bg-gray-900 text-white">
    <select id="continenteInput" class="w-full p-2 mb-3 rounded bg-gray-900 text-white">
      <option value="asia">Asia</option>
      <option value="america">Am√©rica</option>
      <option value="europa">Europa</option>
    </select>
    <input type="file" id="imagenInput" accept="image/*" class="w-full p-2 mb-3 rounded bg-gray-900 text-white">
    <textarea id="letraInput" placeholder="Letra de la canci√≥n" rows="6" class="w-full p-2 mb-3 rounded bg-gray-900 text-white"></textarea>
    <div class="flex justify-end gap-4 mt-4">
      <button onclick="guardarCancion()" class="bg-yellow-400 text-black px-4 py-2 rounded hover:bg-yellow-300">üíæ Guardar</button>
      <button onclick="cancelarFormulario()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal letra -->
<div id="songModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-bg">
  <div class="bg-gray-900 rounded-xl p-6 max-w-2xl w-full shadow-lg relative">
    <button onclick="closeModal()" class="absolute top-2 right-2 text-yellow-400 text-xl hover:text-white">&times;</button>
    <h2 id="songTitle" class="text-yellow-300 text-2xl font-bold mb-4">T√≠tulo</h2>
    <pre id="songLyrics" class="whitespace-pre-wrap text-sm text-white max-h-[60vh] overflow-y-auto leading-relaxed"></pre>
    <div class="text-right mt-6">
      <button onclick="closeModal()" class="bg-yellow-400 text-black px-4 py-2 rounded hover:bg-yellow-500">Cerrar</button>
    </div>
  </div>
</div>

<!-- Script -->
<script>
  let data = [];
  
  const cardsContainer = document.getElementById("cardsContainer");
  const continentFilter = document.getElementById("continentFilter");
  const searchInput = document.getElementById("searchInput");
  const pagination = document.getElementById("pagination");
  
  const songModal = document.getElementById("songModal");
  const songTitle = document.getElementById("songTitle");
  const songLyrics = document.getElementById("songLyrics");
  
  const formModal = document.getElementById("formularioModal");
  
  let currentPage = 1;
  const itemsPerPage = 6;
  
  function getFilteredData() {
    const filter = continentFilter.value;
    const search = searchInput.value.trim().toLowerCase();
    return data.filter(item =>
      (filter === "all" || item.continent === filter) &&
      item.title.toLowerCase().includes(search)
    );
  }
  
  function renderCards() {
    const filteredData = getFilteredData();
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    currentPage = Math.min(currentPage, totalPages || 1);
    const start = (currentPage - 1) * itemsPerPage;
    const pageData = filteredData.slice(start, start + itemsPerPage);
  
    cardsContainer.innerHTML = "";
  
    pageData.forEach(item => {
      const card = document.createElement("div");
      card.className = "bg-gray-800 rounded-lg overflow-hidden shadow hover:scale-105 transition";
  
      card.innerHTML = `
        <img src="/${item.image}" alt="${item.title}" class="w-full h-48 object-cover">
        <div class="p-4 text-center">
          <h3 class="text-lg font-bold text-yellow-300 mb-2">${item.title}</h3>
          <button onclick="showSong('${item.title.replace(/'/g, "\\'")}')" class="bg-yellow-400 text-black px-4 py-1 rounded hover:bg-yellow-500 mb-1">Ver Letra</button>
          <button onclick="editarCancion('${item.title.replace(/'/g, "\\'")}')" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 mb-1">‚úèÔ∏è Editar</button>
          <button onclick="borrarCancion('${item.title.replace(/'/g, "\\'")}')" class="bg-red-600 text-white px-4 py-1 rounded hover:bg-red-700">üóëÔ∏è Borrar</button>
        </div>
      `;
  
      cardsContainer.appendChild(card);
    });
  
    renderPagination(totalPages);
  }
  
  function renderPagination(totalPages) {
    pagination.innerHTML = "";
  
    if (totalPages <= 1) return;
  
    if (currentPage > 1) {
      const prev = document.createElement("button");
      prev.textContent = "‚¨ÖÔ∏è Anterior";
      prev.className = "px-3 py-2 bg-gray-700 rounded hover:bg-gray-600";
      prev.onclick = () => {
        currentPage--;
        renderCards();
      };
      pagination.appendChild(prev);
    }
  
    const label = document.createElement("span");
    label.textContent = `P√°gina ${currentPage} de ${totalPages}`;
    label.className = "text-yellow-400 font-semibold";
    pagination.appendChild(label);
  
    if (currentPage < totalPages) {
      const next = document.createElement("button");
      next.textContent = "Siguiente ‚û°Ô∏è";
      next.className = "px-3 py-2 bg-gray-700 rounded hover:bg-gray-600";
      next.onclick = () => {
        currentPage++;
        renderCards();
      };
      pagination.appendChild(next);
    }
  }
  
  function showSong(title) {
    const selected = data.find(item => item.title === title);
    if (selected) {
      songTitle.textContent = selected.title;
      songLyrics.textContent = selected.lyrics;
      songModal.classList.remove("hidden");
      songModal.classList.add("flex");
    }
  }
  
  function closeModal() {
    songModal.classList.add("hidden");
    songModal.classList.remove("flex");
  }
  
  function mostrarFormularioInsertar() {
    formModal.classList.remove("hidden");
    formModal.classList.add("flex");
    document.getElementById("editIndex").value = "";
    document.getElementById("tituloInput").value = "";
    document.getElementById("continenteInput").value = "asia";
    document.getElementById("letraInput").value = "";
    document.getElementById("imagenInput").value = null;
  }
  
  function editarCancion(title) {
    const index = data.findIndex(item => item.title === title);
    if (index === -1) return;
  
    const song = data[index];
    formModal.classList.remove("hidden");
    formModal.classList.add("flex");
    document.getElementById("editIndex").value = index;
    document.getElementById("tituloInput").value = song.title;
    document.getElementById("continenteInput").value = song.continent;
    document.getElementById("letraInput").value = song.lyrics;
    // No se setea el input tipo file
  }
  
  function cancelarFormulario() {
    formModal.classList.add("hidden");
    formModal.classList.remove("flex");
  }
  
  function guardarCancion() {
    const index = document.getElementById("editIndex").value;
    const formData = new FormData();
    formData.append("title", document.getElementById("tituloInput").value);
    formData.append("continent", document.getElementById("continenteInput").value);
    formData.append("lyrics", document.getElementById("letraInput").value);
  
    const imagen = document.getElementById("imagenInput").files[0];
    if (imagen) formData.append("imagen", imagen);
  
    const method = index === "" ? "POST" : "PUT";
    const url = index === ""
      ? "/api/music"
      : `/api/music/${data[index].id_music}`;
  
    fetch(url, {
      method,
      body: formData
    })
      .then(res => res.json())
      .then(() => fetch("/api/music"))
      .then(res => res.json())
      .then(json => {
        data = Array.isArray(json) ? json : json.data;
        cancelarFormulario();
        renderCards();
      })
      .catch(err => {
        console.error("Error al guardar canci√≥n:", err);
        alert("No se pudo guardar la canci√≥n");
      });
  }
  
  function borrarCancion(title) {
    if (!confirm(`¬øEliminar la canci√≥n "${title}"?`)) return;
    const index = data.findIndex(item => item.title === title);
    if (index !== -1) {
      fetch(`/api/music/${data[index].id_music}`, { method: "DELETE" })
        .then(res => res.json())
        .then(() => fetch("/api/music"))
        .then(res => res.json())
        .then(json => {
          data = Array.isArray(json) ? json : json.data;
          renderCards();
        })
        .catch(err => {
          console.error("Error al borrar canci√≥n:", err);
          alert("No se pudo eliminar la canci√≥n");
        });
    }
  }
  
  // Eventos
  continentFilter.addEventListener("change", () => {
    currentPage = 1;
    renderCards();
  });
  
  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderCards();
  });
  
  // Inicializar
  fetch("/api/music")
  .then(res => res.text()) // ‚Üê en lugar de res.json()
  .then(text => {
    console.log("Respuesta cruda:", text); // üêû
    const json = JSON.parse(text); // ahora parseamos a mano
    data = Array.isArray(json) ? json : json.data;
    renderCards();
  })
  .catch(err => {
    console.error("Error al cargar m√∫sica:", err);
    alert("No se pudieron cargar las canciones");
  });
  </script>
  