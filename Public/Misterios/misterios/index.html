<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listado de Misterios</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }


    #modalDetalle {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 50;
}

#modalDetalle.active {
  display: flex;
}

#modalDetalle .modal-content {
  background-color: #fdfdfd;
  color: #111;
  border-radius: 1rem;
  max-width: 600px;
  max-height: 80vh;
  width: 90%;
  overflow-y: auto;
  padding: 1.5rem;
  position: relative;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
}

  </style>
</head>
<body class="p-6">

<!-- Encabezado -->
<nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
  <a href="../../index.html" class="mx-3 hover:text-yellow-400">Inicio</a>
</nav>

<section class="max-w-7xl mx-auto px-6 mb-10">
  <div class="flex justify-between items-center mt-6 mb-4">
    <h1 class="text-3xl text-yellow-400 font-bold">Misterios Archivados</h1>
    <button onclick="abrirModalInsertar()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">➕ Insertar Misterio</button>
  </div>

  <div class="mb-6">
    <label for="filtro" class="mr-2">Filtrar por etiqueta:</label>
    <select id="filtro" onchange="renderMisterios()" class="bg-gray-800 text-white px-3 py-2 rounded">
      <option value="">Todas</option>
      <option value="IA">IA</option>
      <option value="Diseño">Diseño</option>
      <option value="Código">Código</option>
    </select>
  </div>

  <div id="contenedor" class="grid gap-6 md:grid-cols-4"></div>
</section>

<!-- Modal Insertar -->
<div id="modal-insertar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-gray-900 p-6 rounded-lg w-full max-w-md shadow-2xl">
    <h3 class="text-yellow-400 text-lg font-bold mb-4">➕ Insertar Misterio</h3>
    <input type="text" id="insertar-titulo" placeholder="Título" class="w-full mb-2 px-4 py-2 rounded bg-gray-800 text-white">
    <input type="text" id="insertar-descripcion" placeholder="Descripción" class="w-full mb-2 px-4 py-2 rounded bg-gray-800 text-white">
    <input type="text" id="insertar-etiqueta" placeholder="Etiqueta" class="w-full mb-2 px-4 py-2 rounded bg-gray-800 text-white">
    <input type="file" id="insertar-imagen" accept="image/*" class="w-full mb-4 px-4 py-2 rounded bg-gray-800 text-white">
    <div class="flex justify-end space-x-4">
      <button onclick="cerrarModalInsertar()" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-white">Cancelar</button>
      <button onclick="guardarMisterioInsertado()" class="px-4 py-2 bg-green-500 rounded hover:bg-green-600 text-white">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Editar -->
<div id="modal-editar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-gray-900 p-6 rounded-lg w-full max-w-md shadow-2xl">
    <h3 class="text-yellow-400 text-lg font-bold mb-4">✏️ Editar Misterio</h3>
    <input type="hidden" id="editar-id">
    <input type="text" id="editar-titulo" placeholder="Título" class="w-full mb-2 px-4 py-2 rounded bg-gray-800 text-white">
    <input type="text" id="editar-descripcion" placeholder="Descripción" class="w-full mb-2 px-4 py-2 rounded bg-gray-800 text-white">
    <input type="text" id="editar-etiqueta" placeholder="Etiqueta" class="w-full mb-2 px-4 py-2 rounded bg-gray-800 text-white">
    <input type="file" id="editar-imagen" accept="image/*" class="w-full mb-4 px-4 py-2 rounded bg-gray-800 text-white">
    <div class="flex justify-end space-x-4">
      <button onclick="cerrarModalEditar()" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-white">Cancelar</button>
      <button onclick="guardarEdicion()" class="px-4 py-2 bg-blue-500 rounded hover:bg-blue-600 text-white">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Detalle -->
<div id="modalDetalle" class="hidden">
  <div class="modal-content">
    <button onclick="cerrarModalDetalle()" style="position: absolute; top: 0.5rem; right: 1rem; font-size: 1.5rem; color: #333;">&times;</button>
    <h2 id="detalleTitulo" class="text-2xl font-bold text-yellow-600 mb-2"></h2>
    <p id="detalleEtiqueta" class="text-sm text-purple-700 font-semibold mb-3"></p>
    <img id="detalleImagen" class="w-full h-48 object-cover rounded border border-yellow-400 mb-4" />
    <p id="detalleDescripcion" class="text-sm text-gray-800 whitespace-pre-line"></p>
  </div>
</div>

<script>
  let misterios = [];
  let paginaActual = 1;
  const porPagina = 12;

  // Cargar misterios
  fetch("/api/misterios")
    .then(res => res.json())
    .then(data => {
      misterios = data;
      renderMisterios();
    });

  function renderMisterios() {
    const container = document.getElementById("contenedor");
    container.innerHTML = "";

    const filtro = document.getElementById("filtro").value;
    const filtrados = filtro ? misterios.filter(m => m.etiqueta === filtro) : misterios;

    const paginated = filtrados.slice((paginaActual - 1) * porPagina, paginaActual * porPagina);

    paginated.forEach(item => {
      const card = document.createElement("div");
      card.className = "bg-gray-800 rounded-lg p-4 text-center shadow-lg";

      card.innerHTML = `
        <img src="${item.imagen_url}" alt="${item.titulo}" class="w-full h-32 object-cover rounded mb-2" />
        <h3 class="text-yellow-400 font-bold">${item.titulo}</h3>
        <p class="text-sm text-gray-400 mb-2">${item.etiqueta}</p>
        <div class="flex justify-center gap-2 mt-2">
          <button onclick="verDetalle(${item.id_notas})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">Ver más</button>
          <button onclick="editarMisterio(${item.id_notas})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">Editar</button>
          <button onclick="borrarMisterio(${item.id_notas})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">Eliminar</button>
        </div>
      `;

      container.appendChild(card);
    });
  }

  function abrirModalInsertar() {
    document.getElementById("modal-insertar").classList.remove("hidden");
  }

  function cerrarModalInsertar() {
    document.getElementById("modal-insertar").classList.add("hidden");
  }

  function guardarMisterioInsertado() {
    const imagen = document.getElementById("insertar-imagen").files[0];
    const formData = new FormData();
    formData.append("titulo", document.getElementById("insertar-titulo").value);
    formData.append("descripcion", document.getElementById("insertar-descripcion").value);
    formData.append("etiqueta", document.getElementById("insertar-etiqueta").value);
    formData.append("imagen", imagen);

    fetch("/api/misterios", {
      method: "POST",
      body: formData
    }).then(res => res.json())
      .then(() => {
        location.reload();
      });
  }

  function borrarMisterio(id) {
    if (!confirm("¿Estás seguro de que quieres borrar este misterio?")) return;
    fetch(`/api/misterios/${id}`, {
      method: "DELETE"
    }).then(() => location.reload());
  }

  function editarMisterio(id) {
    const nota = misterios.find(n => n.id_notas === id);
    if (nota) {
      document.getElementById("editar-id").value = nota.id_notas;
      document.getElementById("editar-titulo").value = nota.titulo;
      document.getElementById("editar-descripcion").value = nota.descripcion;
      document.getElementById("editar-etiqueta").value = nota.etiqueta;
      document.getElementById("modal-editar").classList.remove("hidden");
    }
  }

  function cerrarModalEditar() {
    document.getElementById("modal-editar").classList.add("hidden");
  }

  function guardarEdicion() {
    const id = parseInt(document.getElementById("editar-id").value);
    const formData = new FormData();
    formData.append("titulo", document.getElementById("editar-titulo").value);
    formData.append("descripcion", document.getElementById("editar-descripcion").value);
    formData.append("etiqueta", document.getElementById("editar-etiqueta").value);
    const imagen = document.getElementById("editar-imagen").files[0];
    if (imagen) {
      formData.append("imagen", imagen);
    }

    fetch(`/api/misterios/${id}`, {
      method: "PUT",
      body: formData
    }).then(res => res.json())
      .then(() => location.reload());
  }

function verDetalle(id) {
  const nota = misterios.find(n => n.id_notas === id);
  if (!nota) return;

  document.getElementById("detalleTitulo").textContent = nota.titulo;
  document.getElementById("detalleEtiqueta").textContent = `#${nota.etiqueta}`;
  document.getElementById("detalleImagen").src = nota.imagen_url;
  document.getElementById("detalleDescripcion").innerHTML = nota.descripcion;

  const modal = document.getElementById("modalDetalle");
  modal.classList.add("active");
}

function cerrarModalDetalle() {
  const modal = document.getElementById("modalDetalle");
  modal.classList.remove("active");
}

</script>
</body>
</html>
