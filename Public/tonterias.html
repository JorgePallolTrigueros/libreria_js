<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>¿Por qué creemos en tonterías?</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }
    #contenedor-tarjetas img {
      background-color: white;
    }
    .line-clamp-5 {
      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="min-h-screen p-6">





  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="/../e.html" class="mx-3 hover:text-yellow-400">Inicio</a>
  </nav>

  <!-- Encabezado -->
  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <div class="absolute -left-4 md:-left-10 z-20">
  <video autoplay muted loop
         class="w-40 h-40 md:w-52 md:h-52 object-cover rounded-full border-4 border-yellow-400 shadow-2xl">
    <source src="/ruta/tonterias.mp4" type="video/mp4">
  </video>
      </div>
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center pl-48 pr-6 z-10 shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold ml-auto">¿Por qué creemos en tonterías?</h2>
      </div>
    </div>

<a href="tonterias_imagen.html"></a> | <a href="tonterias.html"></a> 

    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">    <div style="width: 1000px;">&nbsp;</div>  <div class="flex gap-2 flex-col md:flex-row w-full md:w-auto">
        <input type="text" id="filtro-nombre" placeholder="Filtrar por nombre..." class="w-full md:w-52 px-2 py-1 rounded text-black" />
        <select id="filtro-departamento" class="w-full md:w-52 px-2 py-1 rounded text-black">
          <option value="">Todos los Departamentos</option>
        </select>
      </div>
    </div>
    <div id="contenedor-tarjetas" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    <div class="flex justify-center mt-6 flex-wrap gap-2" id="paginacion"></div>
 

  <div class="flex justify-end mb-4">
    <button onclick="abrirModalInsertar()" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded">
      + Nuevo Artículo
    </button>

  </div>
   </section>
<div id="modalInsertar" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <form id="formInsertar" class="bg-white text-black p-6 rounded-lg shadow-md w-full max-w-md space-y-4">
    <h3 class="text-lg font-bold text-center text-gray-800">Insertar nuevo artículo</h3>
    
    <input type="text" id="insertNombre" placeholder="Nombre" class="w-full px-3 py-2 border rounded" required>
    
    <textarea id="insertDescripcion" placeholder="Descripción" class="w-full px-3 py-2 border rounded" rows="4"></textarea>
    
    <select id="insertDepartamento" class="w-full px-3 py-2 border rounded" required>
      <option value="">Seleccione Departamento</option>
    </select>
    
    <input type="file" id="insertImagen" accept="image/*" class="w-full">

    <div class="flex justify-between mt-4">
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Guardar</button>
      <button type="button" onclick="cerrarModal('modalInsertar')" class="bg-gray-400 text-black px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
    </div>
  </form>
</div>

<div id="modalEditar" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <form id="formEditar" class="bg-white text-black p-6 rounded-lg shadow-md w-full max-w-md space-y-4">
    <h3 class="text-lg font-bold text-center text-gray-800">Editar artículo</h3>

    <input type="hidden" id="editId">
    
    <input type="text" id="editNombre" placeholder="Nombre" class="w-full px-3 py-2 border rounded" required>
    
    <textarea id="editDescripcion" placeholder="Descripción" class="w-full px-3 py-2 border rounded" rows="4"></textarea>
    
    <select id="editDepartamento" class="w-full px-3 py-2 border rounded" required>
      <option value="">Seleccione Departamento</option>
    </select>
    
    <input type="file" id="editImagen" accept="image/*" class="w-full">

    <div class="flex justify-between mt-4">
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Actualizar</button>
      <button type="button" onclick="cerrarModal('modalEditar')" class="bg-gray-400 text-black px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
    </div>
  </form>
</div>

  <!-- Modales reutilizados de sabemos (pueden insertarse desde archivo externo si se desea) -->
  <!-- Aquí iría el mismo bloque JS reutilizado y adaptado a /api/tonterias -->
</body>
<script>
let tonterias = []; // Global

const departamentos = {
  0: "Mitos personales",
  1: "Creencias colectivas",
  2: "Errores históricos",
  3: "Otros"
};

function abrirModalEditar(id) {
  const item = tonterias.find(a => a.id === parseInt(id));
  if (!item) return;
  document.getElementById("editId").value = item.id;
  document.getElementById("editNombre").value = item.nombre;
  document.getElementById("editDescripcion").value = item.descripcion;
  document.getElementById("editDepartamento").value = item.departamento;
  document.getElementById("modalEditar").classList.remove("hidden");
  document.getElementById("modalEditar").classList.add("flex");
}

function abrirModalInsertar() {
  document.getElementById("insertNombre").value = "";
  document.getElementById("insertDescripcion").value = "";
  document.getElementById("insertDepartamento").value = "";
  document.getElementById("insertImagen").value = "";
  document.getElementById("modalInsertar").classList.remove("hidden");
  document.getElementById("modalInsertar").classList.add("flex");
}

function cerrarModal(id) {
  const modal = document.getElementById(id);
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

function verMas(id) {
  const item = tonterias.find(a => a.id === id);
  if (!item) return;
  document.getElementById("verMasTitulo").textContent = item.nombre;
  document.getElementById("verMasDescripcion").textContent = item.descripcion || "";
  document.getElementById("modalVerMas").classList.remove("hidden");
  document.getElementById("modalVerMas").classList.add("flex");
}

document.addEventListener("DOMContentLoaded", () => {
  const contenedor = document.getElementById("contenedor-tarjetas");
  const filtroNombre = document.getElementById("filtro-nombre");
  const filtroDepartamento = document.getElementById("filtro-departamento");
  const paginacion = document.getElementById("paginacion");
  const editDepartamento = document.getElementById("editDepartamento");
  const insertDepartamento = document.getElementById("insertDepartamento");

  let paginaActual = 1;
  const articulosPorPagina = 8;

  for (const [valor, nombre] of Object.entries(departamentos)) {
    filtroDepartamento.appendChild(new Option(nombre, valor));
    editDepartamento.appendChild(new Option(nombre, valor));
    insertDepartamento.appendChild(new Option(nombre, valor));
  }

  function mostrarArticulos() {
    const filtroNombreValor = filtroNombre.value.toLowerCase();
    const filtroDeptoValor = filtroDepartamento.value;

    console.log('tonterias', tonterias);

    const filtrados = tonterias.filter(a =>
      (a.nombre || "").toLowerCase().includes(filtroNombreValor) &&
      (filtroDeptoValor === "" || a.departamento == filtroDeptoValor)
    );

    const totalPaginas = Math.ceil(filtrados.length / articulosPorPagina);
    if (paginaActual > totalPaginas) paginaActual = 1;

    const inicio = (paginaActual - 1) * articulosPorPagina;
    const paginados = filtrados.slice(inicio, inicio + articulosPorPagina);

    contenedor.innerHTML = "";
    paginados.forEach(a => {
      const nombre = a.nombre || "Sin nombre";
      const descripcion = a.descripcion || "";
      const descripcionCorta = descripcion.length > 300 ? descripcion.slice(0, 300) + "..." : descripcion;
      const imagen = a.imagen || "/tonterias/ima/default.png";
      const departamentoNombre = departamentos[a.departamento] || "Desconocido";
      const id = a.id || a.id_articulo || 0;

      const card = document.createElement("div");
      card.className = "bg-gray-800 rounded-lg shadow-md p-4 flex flex-col items-center";
      card.innerHTML = `
        <img src="${imagen}" alt="${nombre}" class="w-full h-40 object-cover rounded mb-2 shadow">
        <h3 class="text-yellow-400 font-bold text-lg text-center">${nombre}</h3>
        <p class="text-sm text-gray-300 text-center mb-2">${departamentoNombre}</p>
        <p class="text-white text-center text-xs line-clamp-5">${descripcionCorta}</p>
        <div class="mt-2 flex gap-2 justify-center">
          <button onclick="verMas(${id})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded">Ver más</button>
          <button onclick="abrirModalEditar(${id})" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded">Editar</button>
          <button onclick="eliminarArticulo(${id})" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded">Eliminar</button>
        </div>
      `;
      contenedor.appendChild(card);
    });

    paginacion.innerHTML = "";
    for (let i = 1; i <= totalPaginas; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = `px-2 py-1 rounded ${i === paginaActual ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white'} hover:bg-yellow-500 transition`;
      btn.onclick = () => {
        paginaActual = i;
        mostrarArticulos();
      };
      paginacion.appendChild(btn);
    }
  }

  filtroNombre.addEventListener("input", () => {
    paginaActual = 1;
    mostrarArticulos();
  });

  filtroDepartamento.addEventListener("change", () => {
    paginaActual = 1;
    mostrarArticulos();
  });

  fetch("/api/tonterias")
    .then(res => res.json())
    .then(data => {
      tonterias = data;
      mostrarArticulos();
    })
    .catch(err => {
      contenedor.innerHTML = `<p class="text-red-500">Error al cargar los artículos.</p>`;
      console.error("Error:", err);
    });

  document.getElementById("formInsertar").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append("nombre", document.getElementById("insertNombre").value);
    formData.append("descripcion", document.getElementById("insertDescripcion").value);
    formData.append("departamento", document.getElementById("insertDepartamento").value);
    const file = document.getElementById("insertImagen").files[0];
    if (file) formData.append("imagen", file);

    fetch("/api/tonterias", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          cerrarModal("modalInsertar");
          location.reload();
        } else {
          alert("Error al crear artículo");
          console.error(res);
        }
      })
      .catch(err => {
        alert("Error en la conexión");
        console.error(err);
      });
  });

  document.getElementById("formEditar").addEventListener("submit", function (e) {
    e.preventDefault();
    const id = document.getElementById("editId").value;
    const formData = new FormData();
    formData.append("nombre", document.getElementById("editNombre").value);
    formData.append("descripcion", document.getElementById("editDescripcion").value);
    formData.append("departamento", document.getElementById("editDepartamento").value);
    const file = document.getElementById("editImagen").files[0];
    if (file) formData.append("imagen", file);

    fetch(`/api/tonterias/${id}`, {
      method: "PUT",
      body: formData
    })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          cerrarModal("modalEditar");
          location.reload();
        } else {
          alert("Error al editar artículo");
          console.error(res);
        }
      })
      .catch(err => {
        alert("Error en la conexión");
        console.error(err);
      });
  });
});








function eliminarArticulo(id) {
  if (!confirm("¿Seguro que deseas eliminar este artículo?")) return;

  fetch(`/api/tonterias/${id}`, {
    method: "DELETE"
  })
    .then(res => res.json())
    .then(res => {
      if (res.success) {
        alert("Artículo eliminado con éxito");
        location.reload();
      } else {
        alert("Error al eliminar artículo");
        console.error(res);
      }
    })
    .catch(err => {
      alert("Error en la conexión");
      console.error(err);
    });
}



</script>

</html>
