<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compras</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }
    .modal-open { overflow: hidden; }
    .btn { @apply px-3 py-2 rounded font-semibold transition; }
    .btn-prim { @apply bg-yellow-400 text-black hover:bg-yellow-300; }
    .btn-sec { @apply bg-blue-600 hover:bg-blue-800; }
    .btn-danger { @apply bg-red-600 hover:bg-red-800; }
    .btn-ghost { @apply bg-slate-700 hover:bg-slate-600; }
    .input { @apply w-full p-2 rounded bg-slate-800 text-white; }
    .th { @apply p-3 text-sm md:text-base; }
    .td { @apply p-3 align-top text-sm md:text-base; }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="/../e.html" class="mx-3 hover:text-yellow-400">Inicio</a>
    <span class="mx-3 opacity-70">/</span>
    <span class="mx-3 text-yellow-400">Compras</span>
  </nav>

  <section class="max-w-7xl mx-auto px-2 md:px-6 mt-6">
    <div class="flex items-center justify-between gap-4 mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-yellow-400">Compras</h1>

      <div class="flex items-center gap-2">
        <input id="buscador" type="search" placeholder="Buscar por nombre o clase‚Ä¶" class="input w-56 md:w-72" />
        <button id="btnNueva" class="btn btn-prim">‚ûï Nueva compra</button>
      </div>
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto rounded-lg border border-yellow-400">
      <table class="min-w-full text-left">
        <thead class="bg-yellow-400 text-black">
          <tr>
            <th class="th">ID</th>
            <th class="th">Imagen</th>
            <th class="th">Nombre</th>
            <th class="th">Coste</th>
            <th class="th">Clase</th>
            <th class="th">Pros</th>
            <th class="th">Contras</th>
            <th class="th">Resultado</th>
            <th class="th">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyCompras" class="bg-slate-800 divide-y divide-gray-700"></tbody>
      </table>
    </div>

    <!-- Pie con totales -->
    <div class="mt-4 flex items-center justify-end gap-6">
      <div class="text-right">
        <div class="text-sm opacity-70">Total de registros</div>
        <div id="totalRegistros" class="text-xl font-bold text-yellow-400">0</div>
      </div>
      <div class="text-right">
        <div class="text-sm opacity-70">Suma de Coste</div>
        <div id="sumaCoste" class="text-xl font-bold text-yellow-400">‚Ç¨0</div>
      </div>
    </div>
  </section>

  <!-- Modal Alta/Edici√≥n -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden">
    <div class="min-h-full w-full flex items-center justify-center p-4">
      <div class="bg-slate-900 w-full max-w-2xl rounded-xl p-6 relative">
        <button id="btnCerrar" class="absolute top-3 right-3 text-2xl font-bold">&times;</button>
        <h2 id="tituloModal" class="text-2xl text-yellow-400 font-bold mb-4">Nueva compra</h2>

        <form id="formCompra" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="campoId">

          <div>
            <label class="block mb-1">Nombre</label>
            <input id="campoNombre" type="text" class="input" required>
          </div>

          <div>
            <label class="block mb-1">Coste (‚Ç¨)</label>
            <input id="campoCoste" type="number" step="0.01" class="input" required>
          </div>

          <div>
            <label class="block mb-1">Clase</label>
            <input id="campoClase" type="text" class="input" placeholder="p.ej. fat_woman">
          </div>

          <div>
            <label class="block mb-1">Pros</label>
            <input id="campoPros" type="number" class="input" placeholder="N√∫mero de ventajas">
          </div>

          <div>
            <label class="block mb-1">Contras</label>
            <input id="campoContras" type="text" class="input" placeholder="Texto o n√∫mero">
          </div>

          <div>
            <label class="block mb-1">Resultado</label>
            <input id="campoResultado" type="text" class="input" placeholder="p.ej. aprobado / fallido">
          </div>

          <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label class="block mb-1">URL de imagen</label>
              <div class="flex gap-2">
                <input id="campoImagen" type="text" class="input" placeholder="/ima/compras/xxxx.jpg">
                <label class="btn btn-ghost cursor-pointer">
                  Subir
                  <input id="inputUpload" type="file" accept="image/*" class="hidden">
                </label>
              </div>
              <p class="text-xs opacity-60 mt-1">Si subes imagen, se guardar√° v√≠a <code>/api/upload</code> en <code>/ima/compras/</code> y se rellenar√° el campo.</p>
            </div>
            <div>
              <label class="block mb-1">Previsualizaci√≥n</label>
              <img id="previewImg" src="" alt="preview" class="w-full h-28 object-contain bg-white rounded">
            </div>
          </div>

          <div class="md:col-span-2 mt-2 flex justify-end gap-2">
            <button type="button" class="btn btn-ghost" id="btnCancelar">Cancelar</button>
            <button type="submit" class="btn btn-prim" id="btnGuardar">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 border border-yellow-400 text-yellow-400 px-4 py-2 rounded shadow hidden"></div>

  <script>
    // --- Estado ---
    let compras = [];
    let filtro = "";

    // --- Helpers UI ---
    const $ = (id) => document.getElementById(id);
    const showToast = (msg) => {
      const t = $("toast");
      t.textContent = msg;
      t.classList.remove("hidden");
      setTimeout(() => t.classList.add("hidden"), 1800);
    };
    const abrirModal = (modo = "crear", item = null) => {
      document.body.classList.add("modal-open");
      $("modal").classList.remove("hidden");
      $("tituloModal").textContent = (modo === "editar") ? "Editar compra" : "Nueva compra";
      $("formCompra").dataset.modo = modo;

      if (modo === "editar" && item) {
        $("campoId").value = item.id ?? "";
        $("campoNombre").value = item.nombre ?? "";
        $("campoCoste").value = item.Coste ?? "";
        $("campoClase").value = item.clase ?? "";
        $("campoPros").value = item.pros ?? "";
        $("campoContras").value = item.contras ?? "";
        $("campoResultado").value = item.resultado ?? "";
        $("campoImagen").value = item.imagen ?? "";
        $("previewImg").src = item.imagen || "";
      } else {
        $("campoId").value = "";
        $("formCompra").reset();
        $("previewImg").src = "";
      }
    };
    const cerrarModal = () => {
      $("modal").classList.add("hidden");
      document.body.classList.remove("modal-open");
    };

    // --- Render tabla ---
    function render() {
      const tbody = $("tbodyCompras");
      tbody.innerHTML = "";

      const lista = compras
        .filter(c => {
          if (!filtro) return true;
          const f = filtro.toLowerCase();
          return (c.nombre?.toLowerCase().includes(f) || c.clase?.toLowerCase().includes(f));
        })
        .sort((a,b) => (a.id||0) - (b.id||0));

      let suma = 0;

      for (const c of lista) {
        const coste = Number(c.Coste) || 0;
        suma += coste;

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="td whitespace-nowrap">${c.id ?? ""}</td>
          <td class="td">
            ${c.imagen ? `<img src="${c.imagen}" class="w-24 h-16 object-contain bg-white rounded" />` : `<span class="opacity-50">sin imagen</span>`}
          </td>
          <td class="td">${c.nombre ?? ""}</td>
          <td class="td">‚Ç¨${coste.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td class="td">${c.clase ?? ""}</td>
          <td class="td">${c.pros ?? ""}</td>
          <td class="td">${c.contras ?? ""}</td>
          <td class="td">${c.resultado ?? ""}</td>
          <td class="td">
            <div class="flex gap-2">
              <button class="btn btn-sec" data-accion="editar">‚úèÔ∏è</button>
              <button class="btn btn-danger" data-accion="borrar">üóëÔ∏è</button>
            </div>
          </td>
        `;

        // Eventos de fila
        tr.querySelector('[data-accion="editar"]').addEventListener("click", () => abrirModal("editar", c));
        tr.querySelector('[data-accion="borrar"]').addEventListener("click", () => onBorrar(c));

        tbody.appendChild(tr);
      }

      $("totalRegistros").textContent = String(lista.length);
      $("sumaCoste").textContent = "‚Ç¨" + suma.toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- API ---
    async function apiGet() {
      const r = await fetch("/api/compras");
      if (!r.ok) throw new Error("No se pudo cargar /api/compras");
      return await r.json();
    }
    async function apiPost(body) {
      const r = await fetch("/api/compras", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error("No se pudo crear");
      return await r.json();
    }
    async function apiPut(id, body) {
      const r = await fetch(`/api/compras/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error("No se pudo editar");
      return await r.json();
    }
    async function apiDelete(id) {
      const r = await fetch(`/api/compras/${id}`, { method: "DELETE" });
      if (!r.ok) throw new Error("No se pudo borrar");
      return await r.json();
    }
    async function apiUpload(file) {
      const fd = new FormData();
      fd.append("imagen", file);
      fd.append("categoria", "compras");
      const r = await fetch("/api/upload", { method: "POST", body: fd });
      if (!r.ok) throw new Error("Error al subir imagen");
      return await r.json(); // { success, path }
    }

    // --- Handlers ---
    async function cargar() {
      try {
        compras = await apiGet();
        render();
      } catch (e) {
        console.error(e);
        showToast("‚ùå Error cargando compras");
      }
    }

    async function onGuardar(e) {
      e.preventDefault();
      const id = $("campoId").value?.trim();
      const body = {
        nombre: $("campoNombre").value.trim(),
        Coste: Number($("campoCoste").value),
        clase: $("campoClase").value.trim(),
        pros: $("campoPros").value ? Number($("campoPros").value) : $("campoPros").value,
        contras: $("campoContras").value.trim(),
        resultado: $("campoResultado").value.trim(),
        imagen: $("campoImagen").value.trim()
      };

      try {
        if ($("formCompra").dataset.modo === "editar" && id) {
          await apiPut(id, body);
          showToast("‚úÖ Compra actualizada");
        } else {
          await apiPost(body);
          showToast("‚úÖ Compra creada");
        }
        cerrarModal();
        await cargar();
      } catch (err) {
        console.error(err);
        showToast("‚ùå Error al guardar");
      }
    }

    async function onBorrar(item) {
      if (!confirm(`¬øEliminar compra "${item.nombre}" (id ${item.id})?`)) return;
      try {
        await apiDelete(item.id);
        showToast("üóëÔ∏è Eliminado");
        await cargar();
      } catch (e) {
        console.error(e);
        showToast("‚ùå No se pudo eliminar");
      }
    }

    // --- Eventos UI ---
    $("btnNueva").addEventListener("click", () => abrirModal("crear"));
    $("btnCerrar").addEventListener("click", cerrarModal);
    $("btnCancelar").addEventListener("click", cerrarModal);
    $("formCompra").addEventListener("submit", onGuardar);

    $("buscador").addEventListener("input", (e) => {
      filtro = e.target.value || "";
      render();
    });

    $("campoImagen").addEventListener("input", (e) => {
      $("previewImg").src = e.target.value || "";
    });

    $("inputUpload").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const res = await apiUpload(file);
        if (res?.success && res?.path) {
          $("campoImagen").value = res.path;
          $("previewImg").src = res.path;
          showToast("üì∏ Imagen subida");
        } else {
          showToast("‚ö†Ô∏è Fall√≥ la subida");
        }
      } catch (err) {
        console.error(err);
        showToast("‚ùå Error al subir imagen");
      } finally {
        e.target.value = ""; // reset input
      }
    });

    // --- Inicio ---
    cargar();
  </script>
</body>
</html>
