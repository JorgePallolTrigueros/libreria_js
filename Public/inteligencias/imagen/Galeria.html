<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>C√≥mo Funciona la IA de Im√°genes</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
  .modal-imagen {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    margin: auto;
    display: block;
  }

  .modal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.modal-imagen {
  max-width: 50%;
  max-height: 40vh;
  object-fit: contain;
  margin: 1rem auto;
  display: block;
  border-radius: 0.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
.modal-imagen {
  max-width: 80%;
  max-height: 70vh;
  object-fit: contain;
  margin: auto;
  display: block;
}

  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="../../a.html" class="mx-3 hover:text-yellow-400">Inicio</a>
  </nav>

  <!-- Encabezado con imagen y franja -->
  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <!-- Imagen circular -->
      <div class="absolute -left-4 md:-left-10 z-20">
        <video autoplay muted loop class="w-40 h-40 md:w-52 md:h-52 object-cover rounded-full border-4 border-yellow-400 shadow-2xl">
          <source src="/ruta/ia_imagen.mp4" type="video/mp4">
        </video>
      </div>

      <!-- Franja con t√≠tulo -->
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center pl-48 pr-6 z-10 shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold ml-auto">IA IMAGEN</h2>
      </div>
    </div>

    <!-- Men√∫ navegaci√≥n -->
    <nav class="flex justify-end mt-4 space-x-6 text-white text-sm md:text-base">
      <a href="origenes.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Or√≠genes de la IA</a>
      <a href="como-funciona.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">C√≥mo funciona</a>
      <a href="respeto-creatividad.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Respeto a la creatividad</a>
      <a href="ia-sin-censura.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">IA sin censura</a>
      <a href="tutorial-stable-diffusion.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Tutorial SD</a>
      <a href="top10-ia-imagenes.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Top 10 IA Imagen</a>
      <a href="Imagen-Local.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Local</a>
      <a href="midjurnet7.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Midjurney </a>
      <a href="Galeria.html" class="hover:text-yellow-400 transition" style="font-size: 10px;">Galeria </a>
    </nav>

    <!-- Filtros -->
    <label class="block mb-2">Categor√≠a:</label>
    <select id="selectCategoria" class="mb-4 p-2 rounded bg-slate-800 text-white w-full"></select>

    <label class="block mb-2">Subcategor√≠a:</label>
    <select id="selectSubcategoria" class="mb-4 p-2 rounded bg-slate-800 text-white w-full"></select>


<button id="btnBuscar" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow mb-4">
  üîç Buscar
</button>

    <!-- Bot√≥n de nueva imagen -->
    <button onclick="abrirModalInsertar()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded shadow">
      ‚ûï Nueva Imagen
    </button>

<button onclick="limpiarFiltros()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded shadow mb-4 ml-2">
  üßπ Limpiar
</button>









    <!-- Modal Insertar / Editar -->
    <div id="modalFormulario" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
      <div class="bg-white text-black rounded-xl w-full max-w-xl p-6 overflow-y-auto max-h-[90vh]">
        <h2 id="modalTitulo" class="text-xl font-bold text-center text-purple-800 mb-4">Nueva Imagen</h2>

        <label class="block mb-1">Imagen principal:</label>
        <input id="inputImg" name="img" class="w-full p-2 mb-3 border rounded" type="file" accept="image/*" />
        <img id="imagenPrevia" class="modal-imagen hidden" />

        <label class="block mb-1">Versi√≥n 5:</label>
        <input id="inputVersion5" name="version5" class="w-full p-2 mb-3 border rounded" type="file" accept="image/*" />
        <label class="block mb-1">Versi√≥n 6:</label>
        <input id="inputVersion6" name="version6" class="w-full p-2 mb-3 border rounded" type="file" accept="image/*" />
        <label class="block mb-1">Versi√≥n 7:</label>
        <input id="inputVersion7" name="version7" class="w-full p-2 mb-3 border rounded" type="file" accept="image/*" />

        <label class="block mb-1">T√≠tulo:</label>
        <input id="inputTitulo" name="titulo" class="w-full p-2 mb-3 border rounded" type="text" />

        <label class="block mb-1">Texto (HTML permitido):</label>
        <textarea id="inputTexto" name="texto" class="w-full p-2 mb-3 border rounded" rows="4"></textarea>

        <label class="block mb-1">Etiqueta:</label>
        <select id="inputEtiqueta" name="etiqueta" class="w-full p-2 mb-3 border rounded">
          <option value="Midjourney">Midjourney</option>
          <option value="StableDiffusion">StableDiffusion</option>
          <option value="DALL-E">DALL-E</option>
        </select>

        <label class="block mb-1">Categor√≠a:</label>
        <select id="selectCategoriaModal" class="w-full p-2 mb-3 border rounded"></select>

        <label class="block mb-1">Subcategor√≠a:</label>
        <select id="selectSubcategoriaModal" class="w-full p-2 mb-3 border rounded"></select>

        <div class="flex justify-end gap-3">
          <button id="btnCancelar" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">Cancelar</button>
          <button onclick="guardarItem()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">üíæ Guardar</button>
        </div>
      </div>
    </div>







    <div id="pruebasContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"></div>
    <div class="flex justify-center items-center gap-4 mt-4">
      <button id="prev-btn" class="bg-purple-800 hover:bg-purple-700 text-white px-4 py-2 rounded">Anterior</button>
      <span id="page-indicator" class="text-white"></span>
      <button id="next-btn" class="bg-purple-800 hover:bg-purple-700 text-white px-4 py-2 rounded">Siguiente</button>
    </div>



    <!-- Modal Ver M√°s -->
<div id="modalVerMas" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
  <div class="bg-slate-800 text-white rounded-xl p-6 max-w-4xl w-full relative shadow-lg overflow-y-auto max-h-[90vh]">
    <h2 id="verMasTitulo" class="text-2xl font-bold mb-4 text-yellow-400 text-center"></h2>

    <!-- Galer√≠a de im√°genes con nombres -->
    <div id="verMasGaleria" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 justify-items-center text-center text-xs">
      <div>
        <img id="verMasImagen" class="w-full max-w-[120px] rounded shadow" src="" alt="Versi√≥n principal">
        <p>Principal</p>
      </div>
      <div id="version5Container" class="hidden">
        <img id="verMasVersion5" class="w-full max-w-[120px] rounded shadow" src="" alt="Versi√≥n 5">
        <p>Versi√≥n 5</p>
      </div>
      <div id="version6Container" class="hidden">
        <img id="verMasVersion6" class="w-full max-w-[120px] rounded shadow" src="" alt="Versi√≥n 6">
        <p>Versi√≥n 6</p>
      </div>
      <div id="version7Container" class="hidden">
        <img id="verMasVersion7" class="w-full max-w-[120px] rounded shadow" src="" alt="Versi√≥n 7">
        <p>Versi√≥n 7</p>
      </div>
    </div>

    <p id="verMasTexto" class="text-sm text-gray-200 mb-4 leading-relaxed"></p>
    <p id="verMasEtiqueta" class="text-sm text-indigo-300 mb-1"></p>
    <p id="verMasSubcategoria" class="text-sm text-teal-300 mb-4"></p>

    <div class="text-center">
      <button onclick="cerrarModalVerMas()" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded">Cerrar</button>
    </div>
  </div>
</div>


  </section>









<script type="module">
  let datos = []; // ‚Üê GLOBAL

 import { categoriasEscenas } from "./categorias_escenas.js";
  window.categoriasEscenas = categoriasEscenas;

  const categorias = {
    "1": "Escenas",
    "2": "Series"
  };

  let Inteligencia = [];
  let resultadosFiltrados = [];
  let paginaActual = 1;
  const itemsPorPagina = 3;
  let editandoIndice = null;

  const contenedor = document.getElementById("pruebasContainer");
  const indicadorPagina = document.getElementById("page-indicator");


    window.editarItem = function(index) {

      const item = Inteligencia.filter(i => i.id === index)[0];

    //const item = resultadosFiltrados[index];
    abrirModalInsertar(true, index, item);  // <-- aseg√∫rate que esta funci√≥n tambi√©n exista
  };
  

function filtrarPorSubcategoria() {
  const categoriaSeleccionada = document.getElementById("selectCategoria").value;
  const subcategoriaSeleccionada = document.getElementById("selectSubcategoria").value;

  resultadosFiltrados = Inteligencia.filter(item => {
    const coincideCategoria = !categoriaSeleccionada || item.categoria == categoriaSeleccionada;
    const coincideSubcategoria = !subcategoriaSeleccionada || item.subcategoria == subcategoriaSeleccionada;
    return coincideCategoria && coincideSubcategoria;
  });

  paginaActual = 1;
  renderGaleria();
}

  function getRutaValida(img) {
    if (!img) return "";
    if (img.startsWith("http")) return img;
    if (img.startsWith("inteligencias")) return `/${img}`;
    if (img.startsWith("ima/")) return `/inteligencias/imagen/${img}`;
    return `/${img}`;
  }

  function cargarDatos() {
    fetch("/api/ia-imagenes")
      .then(res => res.json())
      .then(data => {
        console.log("Datos cargados desde /api/ia-imagenes:", data);
        Inteligencia = data;
        resultadosFiltrados = [...Inteligencia];
        renderGaleria();
      })
      .catch(err => {
        console.error("Error al cargar Inteligencia:", err);
      });
  }

  function renderGaleria() {
    contenedor.innerHTML = "";
    const inicio = (paginaActual - 1) * itemsPorPagina;
    const fin = inicio + itemsPorPagina;
    const items = resultadosFiltrados.slice(inicio, fin);

    items.forEach((elemento, index) => {
      const imagenes = [
        elemento.img,
        elemento["version 5"],
        elemento["version 6"],
        elemento["version 7"]
      ].filter(src => src);

      const botonesImagen = imagenes.map((src, i) =>
        `<button data-img="${getRutaValida(src)}" class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded mini-button mx-1 text-xs" data-target="card-img-${index}"></button>`
      ).join("");

      const html = `
        <div class="bg-slate-800 rounded-xl overflow-hidden shadow-xl flex flex-col">
          <img id="card-img-${index}" src="${getRutaValida(elemento.img)}" class="w-full h-64 object-cover" alt="Imagen generada por IA">
          <div class="p-4 flex-1 flex flex-col items-center">
            <h5 class="text-yellow-400 text-lg font-semibold mb-2">${elemento.titulo}</h5>
            <div class="flex justify-center mb-2">${botonesImagen}</div>
            <div class="flex justify-center gap-2">
              <button onclick="verMas(${elemento.id})" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm">üîç Ver</button>
              <button onclick="editarItem(${elemento.id})" class="bg-yellow-500 hover:bg-yellow-400 text-white px-3 py-1 rounded text-sm">‚úèÔ∏è Editar</button>
              <button onclick="borrarItem(${elemento.id})" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm">üóëÔ∏è Borrar</button>
            </div>
          </div>
        </div>`;
      contenedor.innerHTML += html;
    });

    document.querySelectorAll(".mini-button").forEach(button => {
      button.addEventListener("click", function () {
        const imgSrc = this.getAttribute("data-img");
        const targetId = this.getAttribute("data-target");
        const img = document.getElementById(targetId);
        if (img) img.src = imgSrc;
      });
    });

    const totalPaginas = Math.ceil(resultadosFiltrados.length / itemsPorPagina);
    indicadorPagina.textContent = `P√°gina ${paginaActual} de ${totalPaginas}`;
  }



  // Cuando el DOM est√© listo
  document.addEventListener("DOMContentLoaded", () => {
    const btnPrev = document.getElementById("prev-btn");
    const btnNext = document.getElementById("next-btn");
    document.getElementById("btnBuscar")?.addEventListener("click", filtrarPorSubcategoria);
    const selectCategoria = document.getElementById("selectCategoria");
    const selectSubcategoria = document.getElementById("selectSubcategoria");
    const selectCategoriaModal = document.getElementById("selectCategoriaModal");
    const selectSubcategoriaModal = document.getElementById("selectSubcategoriaModal");

    // Cargar categor√≠as principales en ambos selects
    [selectCategoria, selectCategoriaModal].forEach(select => {
      if (select) {
        select.innerHTML = `<option value="">-- Selecciona categor√≠a --</option>`;
        for (const [valor, texto] of Object.entries(categorias)) {
          const opt = document.createElement("option");
          opt.value = valor;
          opt.textContent = texto;
          select.appendChild(opt);
        }
      }
    });







    // Listeners para cambio de categor√≠a
    selectCategoria?.addEventListener("change", () => actualizarSubcategorias(selectCategoria.value, selectSubcategoria));
    selectCategoriaModal?.addEventListener("change", () => actualizarSubcategorias(selectCategoriaModal.value, selectSubcategoriaModal));

    function actualizarSubcategorias(categoriaSeleccionada, selectDestino) {
      if (!selectDestino) return;

      selectDestino.innerHTML = `<option value="">-- Selecciona subcategor√≠a --</option>`;

      categoriasEscenas
        .filter(item => String(item.categoria) === String(categoriaSeleccionada))
        .forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.nombre;
          opt.textContent = item.nombre;
          selectDestino.appendChild(opt);
        });
    }

    // Navegaci√≥n
    btnPrev?.addEventListener("click", () => {
      if (paginaActual > 1) {
        paginaActual--;
        renderGaleria();
      }
    });

    btnNext?.addEventListener("click", () => {
      const totalPaginas = Math.ceil(resultadosFiltrados.length / itemsPorPagina);
      if (paginaActual < totalPaginas) {
        paginaActual++;
        renderGaleria();
      }
    });

    cargarDatos(); // Inicial
  });



window.abrirModalInsertar = function(esEdicion = false, index = null, item = null) {
  const modal = document.getElementById("modalFormulario");
  const tituloModal = document.getElementById("modalTitulo");

  // Limpiar campos
  document.getElementById("inputImg").value = "";
  document.getElementById("inputVersion5").value = "";
  document.getElementById("inputVersion6").value = "";
  document.getElementById("inputVersion7").value = "";
  document.getElementById("inputTitulo").value = "";
  document.getElementById("inputTexto").value = "";
  document.getElementById("inputEtiqueta").value = "";
  document.getElementById("selectCategoriaModal").value = "";
  document.getElementById("selectSubcategoriaModal").innerHTML = "<option value=''>-- Selecciona subcategor√≠a --</option>";
  document.getElementById("imagenPrevia").classList.add("hidden");

  // Si estamos editando, rellenamos los campos
  if (esEdicion && item) {
    window.editandoIndice = index;  // ‚úÖ ESTO FALTABA

    tituloModal.textContent = "Editar Imagen";
    document.getElementById("inputTitulo").value = item.titulo || "";
    document.getElementById("inputTexto").value = item.texto || "";
    document.getElementById("inputEtiqueta").value = item.etiqueta || "";
    document.getElementById("selectCategoriaModal").value = item.categoria || "";

    const subSelect = document.getElementById("selectSubcategoriaModal");
    subSelect.innerHTML = `<option value="">-- Selecciona subcategor√≠a --</option>`;
    categoriasEscenas
      .filter(cat => String(cat.categoria) === String(item.categoria))
      .forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.nombre;
        opt.textContent = cat.nombre;
        subSelect.appendChild(opt);
      });
    document.getElementById("selectSubcategoriaModal").value = item.subcategoria || "";

  } else {
    window.editandoIndice = null;  // ‚úÖ RESET al insertar
    tituloModal.textContent = "Nueva Imagen";
  }

  modal.classList.remove("hidden");
};








window.cerrarModal = function () {
  const modal = document.getElementById("modalFormulario");
  modal.classList.add("hidden");
}


document.getElementById("btnCancelar")?.addEventListener("click", () => {
  document.getElementById("modalFormulario").classList.add("hidden");
});












window.guardarItem = function () {
  const titulo = document.getElementById("inputTitulo").value.trim();
  const texto = document.getElementById("inputTexto").value.trim();
  const etiqueta = document.getElementById("inputEtiqueta").value;
  const categoria = document.getElementById("selectCategoriaModal").value;
  const subcategoria = document.getElementById("selectSubcategoriaModal").value;

  const imagenPrincipal = document.getElementById("inputImg").files[0];
  const version5 = document.getElementById("inputVersion5").files[0];
  const version6 = document.getElementById("inputVersion6").files[0];
  const version7 = document.getElementById("inputVersion7").files[0];

  const formData = new FormData();
  formData.append("titulo", titulo);
  formData.append("texto", texto);
  formData.append("etiqueta", etiqueta);
  formData.append("categoria", categoria);
  formData.append("subcategoria", subcategoria);

if (imagenPrincipal) formData.append("img", imagenPrincipal);          // ‚úÖ
if (version5) formData.append("version 5", version5);                  // ‚úÖ
if (version6) formData.append("version 6", version6);                  // ‚úÖ
if (version7) formData.append("version 7", version7);                  // ‚úÖ

  const esEdicion = typeof window.editandoIndice === "number";

  // Importante: agregar ID expl√≠cito para la edici√≥n
  if (esEdicion) {
    formData.append("id", window.editandoIndice);
  }

  const url = esEdicion
    ? `/api/ia-imagenes/${window.editandoIndice}`
    : `/api/ia-imagenes`;

  const metodo = esEdicion ? "PUT" : "POST";

  fetch(url, {
    method: metodo,
    body: formData,
  })
    .then((res) => {
      // Si el servidor responde con HTML (como un error 404 o p√°gina de error), el .json() fallar√°
      const contentType = res.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        return res.json();
      } else {
        throw new Error("Respuesta inesperada del servidor (no es JSON)");
      }
    })
    .then((res) => {
      alert("‚úÖ Imagen guardada correctamente");
      cerrarModal();
      cargarDatos();
    })
    .catch((err) => {
      console.error("Error al guardar:", err);
      alert("‚ùå Error al guardar la imagen");
    });
};



window.verMas = function (index) {
  const item = Inteligencia.filter(i => i.id === index)[0];

  // Limpieza de rutas: eliminar "public\" o "public/" y usar "/"
  const limpiarRuta = ruta => ruta ? "/" + ruta.replace(/^public[\\/]/, "").replace(/\\/g, "/") : "";

  document.getElementById("verMasTitulo").textContent = item.titulo || "Sin t√≠tulo";
  document.getElementById("verMasTexto").innerHTML = item.texto || "";
  console.log('item', item);
  document.getElementById("verMasEtiqueta").textContent = `Etiqueta: ${item.etiqueta || "Ninguna"}`;
  document.getElementById("verMasSubcategoria").textContent = `Subcategor√≠a: ${item.subcategoria || "Ninguna"}`;

  // Imagen principal
  console.log('item', item);
  document.getElementById("verMasImagen").src = limpiarRuta(item.img);

  // Versiones
  const v5 = document.getElementById("verMasVersion5");
  const v6 = document.getElementById("verMasVersion6");
  const v7 = document.getElementById("verMasVersion7");

  const c5 = document.getElementById("version5Container");
  const c6 = document.getElementById("version6Container");
  const c7 = document.getElementById("version7Container");

  if (item["version 5"]) {
    v5.src = limpiarRuta(item["version 5"]);
    c5.classList.remove("hidden");
  } else {
    c5.classList.add("hidden");
  }

  if (item["version 6"]) {
    v6.src = limpiarRuta(item["version 6"]);
    c6.classList.remove("hidden");
  } else {
    c6.classList.add("hidden");
  }

  if (item["version 7"]) {
    v7.src = limpiarRuta(item["version 7"]);
    c7.classList.remove("hidden");
  } else {
    c7.classList.add("hidden");
  }

  // Mostrar el modal
  document.getElementById("modalVerMas").classList.remove("hidden");
};

window.cerrarModalVerMas = function () {
  document.getElementById("modalVerMas").classList.add("hidden");
};


window.borrarItem = function (id) {
  if (!confirm(`¬øSeguro que quieres borrar esta imagen?`)) return;

  fetch(`/api/ia-imagenes/${id}`, {
    method: "DELETE",
  })
    .then(res => {
      if (!res.ok) throw new Error("Error al borrar");
      alert("‚úÖ Imagen borrada correctamente");
      cargarDatos();
    })
    .catch(err => {
      console.error("Error al borrar:", err);
      alert("‚ùå No se pudo borrar la imagen");
    });
};

window.limpiarFiltros = function () {
  document.getElementById("selectCategoria").value = "";
  document.getElementById("selectSubcategoria").innerHTML = `<option value="">-- Selecciona subcategor√≠a --</option>`;
  resultadosFiltrados = [...Inteligencia];
  paginaActual = 1;
  renderGaleria();
};


</script>