<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gastos</title>
  <script src="/assets/tailwind.js"></script>
  <link href="/assets/fonts.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #0f172a;
      color: white;
    }
    #contenedor-tarjetas img {
      background-color: white;
    }
    .line-clamp-5 {
      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-purple-800 via-indigo-800 to-blue-800 p-4 text-center text-sm md:text-base font-semibold uppercase tracking-wider">
    <a href="/../f.html" class="mx-3 hover:text-yellow-400">Inicio</a>
  </nav>

  <!-- Encabezado -->
  <section class="max-w-7xl mx-auto px-6 mb-10">
    <div class="relative flex items-center justify-between">
      <div class="absolute -left-4 md:-left-10 z-20">
        <video autoplay muted loop
               class="w-40 h-40 md:w-52 md:h-52 object-cover rounded-full border-4 border-yellow-400 shadow-2xl">
          <source src="/ruta/compras.mp4" type="video/mp4">
        </video>
      </div>
      <div class="w-full bg-purple-800 h-28 md:h-32 rounded-xl flex items-center pl-48 pr-6 z-10 shadow-lg">
        <h2 class="text-2xl md:text-4xl text-yellow-400 font-bold ml-auto">Gastos</h2>
      </div>
    </div>
  <div style="height: 100px;">&nbsp;</div>
    <div>
      <a href="login.html" class="bg-yellow-400 text-black px-4 py-2 rounded font-bold hover:bg-yellow-300 transition">
        Iniciar sesi√≥n
      </a>
    </div>

  

  <h1 class="text-center text-4xl font-bold mb-6 text-yellow-400">Gastos</h1>

  <div class="text-center mb-10" id="addButtonContainer" style="display:none;">
    <button onclick="abrirModalInsertar()" class="bg-yellow-400 text-black px-6 py-3 rounded font-bold text-lg shadow hover:scale-105 transition">‚ûï A√±adir Gasto</button>
  </div>

  <!-- Modal -->
  <div id="modalForm" class="modal fixed inset-0 bg-black bg-opacity-80 justify-center items-center z-50 flex hidden">
    <div class="bg-slate-900 p-6 rounded-lg max-w-md w-full relative">
      <button onclick="cerrarModal()" class="absolute top-2 right-2 text-white text-2xl font-bold">&times;</button>
      <h2 class="text-2xl text-yellow-400 mb-4 font-bold text-center">Agregar / Editar Gasto</h2>
      <form id="formGasto" class="space-y-4">
        <input type="hidden" id="gastoIndex" value="-1">
        <div>
          <label class="block mb-1">Tipo:</label>
          <input type="text" id="tipo" class="w-full p-2 rounded bg-slate-800 text-white" required>
        </div>
        <div>
          <label class="block mb-1">Contexto:</label>
          <input type="text" id="contexto" class="w-full p-2 rounded bg-slate-800 text-white" required>
        </div>
        <div>
          <label class="block mb-1">Cantidad (‚Ç¨):</label>
          <input type="number" id="gasto" class="w-full p-2 rounded bg-slate-800 text-white" required>
        </div>
        <button type="submit" class="bg-yellow-400 text-black px-4 py-2 rounded font-bold w-full">Guardar</button>
      </form>
    </div>
  </div>

  <!-- Tabla -->
  <div class="overflow-x-auto">
    <table class="w-full text-left border border-yellow-400 rounded-lg overflow-hidden">
      <thead class="bg-yellow-400 text-black">
        <tr>
          <th class="p-3">Contexto</th>
          <th class="p-3">Activo</th>
          <th class="p-3">Fecha</th>
          <th class="p-3">Cantidad</th>
          <th class="p-3">Veces</th>
          <th class="p-3">Total</th>
          <th class="p-3">Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaGastos" class="bg-slate-800 divide-y divide-gray-600"></tbody>
      <tfoot>
        <tr>
          <td colspan="5" class="p-3 text-right font-bold text-yellow-400">Total del mes:</td>
          <td id="totalFinal" class="p-3 font-bold text-yellow-400">‚Ç¨0</td>
        </tr>
      </tfoot>
    </table>
  </div>
  </section>
  <script>
    let datos = [];

    async function cargar() {
      const res = await fetch('/api/gastos');
      datos = await res.json();
      renderizar();
    }

    function renderizar() {
      const tabla = document.getElementById("tablaGastos");
      const totalFinal = document.getElementById("totalFinal");
      const admin = localStorage.getItem("admin");
      tabla.innerHTML = "";
      let sumaTotal = 0;

      datos.forEach((item, i) => {
        const total = item.activo ? item.Gasto * item.veces : 0;
        sumaTotal += total;

        const opciones = [1, 2, 3, 4].map(n =>
          `<option value="${n}" ${item.veces === n ? 'selected' : ''}>${n}</option>`
        ).join('');

        tabla.innerHTML += `
          <tr>
            <td class="p-3">${item.Contexto}</td>
            <td class="p-3">
              ${admin ? `
                <button onclick="toggleActivo(${i})" class="px-2 py-1 rounded ${item.activo ? 'bg-green-600 hover:bg-green-800' : 'bg-red-600 hover:bg-red-800'}">
                  ${item.activo ? 'Activo' : 'Inactivo'}
                </button>
              ` : '<span class="text-gray-400">Oculto</span>'}
            </td>
            <td class="p-3">${item.fecha}</td>
            <td class="p-3">‚Ç¨${item.Gasto}</td>
            <td class="p-3">
              ${admin ? `<select onchange="cambiarVeces(${i}, this.value)" class="bg-slate-700 text-yellow-400 rounded px-2 py-1">${opciones}</select>` : `<span class="text-gray-400">${item.veces}</span>`}
            </td>
            <td class="p-3">‚Ç¨${total}</td>
            <td class="p-3 space-x-2">
              ${admin ? `
                <button onclick="editar(${i})" class="bg-blue-600 hover:bg-blue-800 px-2 py-1 rounded">‚úèÔ∏è</button>
                <button onclick="borrar(${i})" class="bg-red-600 hover:bg-red-800 px-2 py-1 rounded">üóëÔ∏è</button>
              ` : ''}
            </td>
          </tr>`;
      });

      totalFinal.innerText = `‚Ç¨${sumaTotal}`;
    }

    function abrirModalInsertar() {
      document.getElementById("formGasto").reset();
      document.getElementById("gastoIndex").value = -1;
      document.getElementById("modalForm").classList.remove("hidden");
    }

    function cerrarModal() {
      document.getElementById("modalForm").classList.add("hidden");
    }

    async function toggleActivo(i) {
      datos[i].activo = !datos[i].activo;
      await fetch(`/api/gastos/${i}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos[i])
      });
      cargar();
    }

    async function cambiarVeces(i, value) {
      datos[i].veces = parseInt(value);
      await fetch(`/api/gastos/${i}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos[i])
      });
      cargar();
    }

    function editar(i) {
      const g = datos[i];
      document.getElementById("tipo").value = g.Tipo;
      document.getElementById("contexto").value = g.Contexto;
      document.getElementById("gasto").value = g.Gasto;
      document.getElementById("gastoIndex").value = i;
      document.getElementById("modalForm").classList.remove("hidden");
    }

    async function borrar(i) {
      if (confirm("¬øEliminar este gasto?")) {
        await fetch(`/api/gastos/${i}`, { method: "DELETE" });
        cargar();
      }
    }

    document.getElementById("formGasto").addEventListener("submit", async function(e) {
      e.preventDefault();
      const index = parseInt(document.getElementById("gastoIndex").value);
      const nuevo = {
        Tipo: document.getElementById("tipo").value,
        Contexto: document.getElementById("contexto").value,
        Gasto: parseFloat(document.getElementById("gasto").value)
      };

      if (index === -1) {
        await fetch('/api/gastos', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuevo)
        });
      } else {
        await fetch(`/api/gastos/${index}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuevo)
        });
      }

      cerrarModal();
      cargar();
    });

    if (localStorage.getItem("admin")) {
      document.getElementById("addButtonContainer").style.display = "block";
    }

    cargar();
  </script>
</body>
</html>
